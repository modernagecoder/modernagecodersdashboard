<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Scheduling System - Pro // Code-Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">

    <style>
        :root {
            /* Core Coding Theme Palette */
            --bg-primary: #1A1B26;
            /* Deep dark blue/purple - editor background */
            --bg-secondary: #2A2D3A;
            /* Slightly lighter for cards/modals */
            --bg-tertiary: #3B3E4D;
            /* Hover states, subtle backgrounds */
            --text-primary: #C0CAF5;
            /* Light lavender/blue for primary text */
            --text-secondary: #A9B1D6;
            /* Slightly muted text */
            --text-muted: #787C99;
            --accent-main: #7AA2F7;
            /* Bright blue for primary actions, links */
            --accent-secondary: #BB9AF7;
            /* Purple for secondary actions, highlights */
            --accent-green: #9ECE6A;
            /* Green for success, confirmations */
            --accent-yellow: #E0AF68;
            /* Yellow for warnings, attention */
            --accent-red: #F7768E;
            /* Red for danger, deletions */
            --accent-orange: #FF9E64;
            /* Orange for specific highlights */
            --border-color: #444B5A;
            --border-radius: 6px;
            /* Slightly reduced for a sharper look */
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            --box-shadow-hover: 0 6px 12px rgba(0, 0, 0, 0.2);
            --transition-speed: 0.2s;
            --font-primary: 'Poppins', sans-serif;
            --font-code: 'Fira Code', monospace;
            /* testing  */
        }

        body {
            font-family: var(--font-primary);
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.7;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-top: 20px;
            overflow-x: hidden;
            /* Prevent horizontal scrolling */
            width: 100%;
            position: relative;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 30px;
            /* Adjusted padding */
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            overflow-x: hidden;
            /* Prevent container overflow */
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-1 {
            margin-bottom: 0.75rem;
        }

        .mb-2 {
            margin-bottom: 1.25rem;
        }

        .mb-3 {
            margin-bottom: 1.75rem;
        }

        .mt-1 {
            margin-top: 0.75rem;
        }

        .mt-2 {
            margin-top: 1.25rem;
        }

        .mt-3 {
            margin-top: 1.75rem;
        }

        /* --- BUTTON REDESIGN --- */
        button,
        .btn {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95rem;
            /* Consistent font size */
            font-weight: 500;
            transition: all var(--transition-speed) ease-in-out;
            text-decoration: none;
            display: inline-flex;
            /* Use flex for alignment */
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* Space between icon and text */
            letter-spacing: 0.3px;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        button:hover:not(:disabled) {
            border-color: var(--accent-main);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
        }

        /* Primary Button Style */
        .btn-primary {
            background-color: var(--accent-main);
            color: var(--bg-primary);
            border-color: var(--accent-main);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #638ef5;
            border-color: #638ef5;
            color: var(--bg-primary);
        }

        /* Secondary Button Style */
        .btn-secondary {
            background-color: var(--accent-secondary);
            color: var(--bg-primary);
            border-color: var(--accent-secondary);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #a883f5;
            border-color: #a883f5;
            color: var(--bg-primary);
        }

        /* Danger Button Style */
        .btn-danger {
            background-color: var(--accent-red);
            color: var(--bg-primary);
            border-color: var(--accent-red);
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #f56078;
            border-color: #f56078;
            color: var(--bg-primary);
        }

        /* Success Button Style */
        .btn-success {
            background-color: var(--accent-green);
            color: var(--bg-primary);
            border-color: var(--accent-green);
        }

        .btn-success:hover:not(:disabled) {
            background-color: #8ac75a;
            border-color: #8ac75a;
            color: var(--bg-primary);
        }

        /* Warning Button Style */
        .btn-warning {
            background-color: var(--accent-yellow);
            color: var(--bg-primary);
            border-color: var(--accent-yellow);
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d9a05a;
            border-color: #d9a05a;
            color: var(--bg-primary);
        }

        /* Outline Button Style */
        .btn-outline-primary {
            background-color: transparent;
            color: var(--accent-main);
            border-color: var(--accent-main);
        }

        .btn-outline-primary:hover:not(:disabled) {
            background-color: var(--accent-main);
            color: var(--bg-primary);
        }

        /* --- END BUTTON REDESIGN --- */


        /* Forms */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        select,
        input.flatpickr-input,
        input[type="checkbox"],
        input[type="radio"] {
            width: calc(100% - 26px);
            padding: 12px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: var(--font-primary);
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            box-sizing: border-box;
        }

        input.flatpickr-input {
            cursor: pointer;
        }

        input[type="checkbox"],
        input[type="radio"] {
            width: auto;
            margin-right: 10px;
            margin-bottom: 0;
            accent-color: var(--accent-main);
        }


        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        select:focus,
        input.flatpickr-input:focus,
        input[type="checkbox"]:focus,
        input[type="radio"]:focus {
            outline: none;
            border-color: var(--accent-main);
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.3);
        }

        label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }


        /* --- Enhanced Header --- */
        #app-header {
            display: flex;
            flex-direction: column;
            /* Stack main and secondary content */
            gap: 1.5rem;
            /* Space between main and secondary sections */
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
            /* More space below header */
        }

        #header-main-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        #app-header h1 {
            /* Main title "Weekly Schedule" */
            font-size: 2.2rem;
            /* Slightly larger */
            font-weight: 700;
            /* Bolder */
            color: var(--accent-secondary);
            margin: 0;
            letter-spacing: 0.5px;
            cursor: pointer;
            /* Make it clickable to return to main view */
        }

        #user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.95rem;
        }

        #user-display-name {
            font-weight: 500;
            color: var(--accent-main);
        }

        #user-display-name.is-admin {
            color: var(--accent-orange);
            /* Make admin name stand out */
            font-weight: 600;
        }


        #header-secondary-content {
            display: flex;
            flex-direction: column;
            /* Stack date and stats on smaller screens */
            gap: 1.25rem;
            /* Space between date and stats */
            width: 100%;
            align-items: center;
            /* Center content by default */
        }

        #current-date-display-container {
            width: 100%;
            text-align: center;
            /* Center the date */
            padding: 10px 0;
            background-color: rgba(var(--bg-tertiary-rgb, 59, 62, 77), 0.3);
            /* Use RGB for opacity */
            border-radius: var(--border-radius);
        }

        #current-date-display {
            font-size: 1.25rem;
            /* More prominent */
            font-weight: 600;
            color: var(--text-primary);
        }

        #teacher-stats-container {
            display: flex;
            flex-wrap: wrap;
            /* Allow wrapping on smaller screens */
            gap: 15px;
            /* Space between stat items */
            justify-content: center;
            /* Center stat items */
            width: 100%;
            padding: 15px;
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        #teacher-stats-container .stat-label-admin-note {
            font-size: 0.7em;
            color: var(--text-muted);
            display: block;
            margin-top: 4px;
            font-style: italic;
        }


        .stat-item {
            background-color: var(--bg-secondary);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            text-align: center;
            min-width: 150px;
            /* Minimum width for each stat card */
            flex-grow: 1;
            /* Allow items to grow */
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            display: block;
            font-size: 2rem;
            /* Large stat number */
            font-weight: 700;
            color: var(--accent-main);
            margin-bottom: 5px;
            font-family: var(--font-code);
            /* Use code font for numbers */
        }

        /* NEW: Style for earnings stats */
        .stat-value.earnings {
            color: var(--accent-green);
        }

        .stat-label {
            font-size: 0.8rem;
            /* Slightly smaller for a cleaner look */
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            /* Wider spacing looks more professional */
            font-weight: 500;
            /* A slightly bolder weight */
        }

        /* --- End Enhanced Header --- */


        /* Week Selector & Navigation - Enhanced */
        #week-navigation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 2.5rem;
        }

        .nav-arrow {
            padding: 8px;
            /* Adjusted padding for a square look */
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            flex-shrink: 0;
            line-height: 1;
        }

        .nav-arrow:hover {
            background-color: var(--accent-main);
            border-color: var(--accent-main);
            color: var(--bg-primary);
        }

        #week-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            flex-grow: 1;
        }

        #week-selector button {
            flex-grow: 1;
            min-width: 130px;
            font-weight: 500;
            padding: 10px 15px;
            line-height: 1.4;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border-color: var(--border-color);
            flex-direction: column;
            /* Stack day and date */
            gap: 2px;
            /* Reduced gap for day/date */
        }

        #week-selector button .date-small {
            font-size: 0.75em;
            color: var(--text-muted);
            font-family: var(--font-code);
        }

        #week-selector button:hover {
            background-color: var(--accent-secondary);
            color: var(--bg-primary);
            border-color: var(--accent-secondary);
        }

        #week-selector button.active-day {
            background-color: var(--accent-main) !important;
            color: var(--bg-primary) !important;
            border-color: var(--accent-main) !important;
            transform: translateY(-2px);
        }

        #week-selector button.active-day .date-small {
            color: var(--bg-tertiary);
        }


        /* Day Schedule View */
        #day-schedule-view h2#day-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--accent-secondary);
        }

        #slots-list {
            list-style: none;
            padding: 0;
        }

        .slots-grid {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .slot-item {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--accent-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .slot-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--box-shadow-hover);
            border-left-color: var(--accent-main);
        }

        .slot-item.is-own {
            border-left-color: var(--accent-main);
        }

        .slot-item.is-other-teacher {
            border-left-color: var(--accent-orange);
        }

        .slot-item.is-cancelled {
            opacity: 0.6;
            border-left-color: var(--text-muted);
            background-color: var(--bg-tertiary);
        }

        .slot-item.is-cancelled .slot-details .topic {
            text-decoration: line-through;
        }


        .slot-details {
            margin-bottom: 15px;
        }

        .slot-details strong {
            color: var(--accent-main);
            font-size: 1.15em;
            font-family: var(--font-code);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slot-details .topic {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .slot-details .teacher {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .slot-details .teacher .admin-view-teacher-highlight {
            font-weight: 600;
            color: var(--accent-yellow);
        }

        .slot-details .status-cancelled {
            font-size: 0.9em;
            color: var(--accent-yellow);
            margin-top: 5px;
            font-style: italic;
        }

        .slot-details .status-cancelled strong {
            color: var(--accent-orange);
        }

        /* NEW: Style for the class tag */
        .slot-tag {
            background-color: var(--accent-secondary);
            color: var(--bg-primary);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: var(--font-primary);
        }

        /* START: NEW STYLE FOR TIMESTAMP */
        .slot-timestamp-info {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
            font-style: italic;
            font-family: var(--font-code);
        }

        /* END: NEW STYLE FOR TIMESTAMP */


        .slot-actions {
            margin-top: auto;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .slot-actions button {
            font-size: 0.8rem;
            padding: 6px 12px;
            /* Smaller padding for action buttons */
        }

        /* Auth View Styling */
        #auth-view h1 {
            color: var(--accent-secondary);
            margin-bottom: 2rem;
            letter-spacing: 1px;
            font-size: 2.2rem;
        }

        #auth-view h1 .code-emphasis {
            font-family: var(--font-code);
            color: var(--accent-main);
            font-weight: 600;
        }

        #auth-view h2 {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        #auth-view p a {
            color: var(--accent-main);
            text-decoration: none;
            font-weight: 500;
        }

        #auth-view p a:hover {
            text-decoration: underline;
            color: var(--accent-secondary);
        }

        #auth-view input[type="email"]:focus,
        #auth-view input[type="password"]:focus,
        #auth-view input[type="text"]:focus {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 3px rgba(187, 154, 247, 0.4);
        }

        #auth-view .btn-primary:hover:not(:disabled) {
            box-shadow: 0 0 18px rgba(122, 162, 247, 0.6);
        }

        #auth-view .btn-success:hover:not(:disabled) {
            box-shadow: 0 0 18px rgba(158, 206, 106, 0.6);
        }


        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 27, 38, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease, visibility 0s var(--transition-speed) ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 550px;
            transform: scale(0.95) translateY(20px);
            transition: transform var(--transition-speed) cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--border-color);
        }

        .modal.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.75rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-secondary);
            font-size: 1.6rem;
            font-weight: 600;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 2.2rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color var(--transition-speed) ease;
            padding: 0;
            /* Reset padding */
            width: 30px;
            height: 30px;
        }

        .close-button:hover {
            color: var(--accent-red);
            background-color: transparent;
            box-shadow: none;
            transform: none;
            border: none;
        }

        .time-inputs-container {
            display: flex;
            gap: 20px;
            margin-bottom: 1.25rem;
        }

        .time-inputs-container>div {
            flex: 1;
        }

        #teacher-select-container-for-admin {
            margin-bottom: 1.25rem;
        }

        /* Style for admin teacher selector */


        /* Notifications */
        #notifications {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 1050;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notification {
            padding: 14px 20px;
            border-radius: var(--border-radius);
            color: var(--bg-primary);
            background-color: var(--text-primary);
            box-shadow: var(--box-shadow);
            opacity: 0;
            transform: translateX(110%);
            animation: slideInFade 0.5s forwards, slideOutFade 0.5s 4.5s forwards;
            font-weight: 500;
            border-left: 5px solid;
        }

        .notification.error {
            background-color: var(--accent-red);
            border-left-color: #c7586e;
            color: white;
        }

        .notification.success {
            background-color: var(--accent-green);
            border-left-color: #7cb850;
            color: var(--bg-primary);
        }

        .notification.warning {
            background-color: var(--accent-yellow);
            border-left-color: #c89551;
            color: var(--bg-primary);
        }

        .notification.info {
            background-color: var(--accent-main);
            border-left-color: var(--accent-main);
            color: var(--bg-primary);
        }


        @keyframes slideInFade {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutFade {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(110%);
            }
        }

        /* Flatpickr Customizations */
        .flatpickr-calendar {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
            width: auto;
        }

        .flatpickr-months .flatpickr-month {
            color: var(--text-primary);
            fill: var(--text-primary);
        }

        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            fill: var(--accent-main) !important;
        }

        .flatpickr-months .flatpickr-prev-month:hover svg,
        .flatpickr-months .flatpickr-next-month:hover svg {
            fill: var(--accent-secondary) !important;
        }

        span.flatpickr-weekday {
            color: var(--accent-secondary);
        }

        .flatpickr-day {
            color: var(--text-secondary);
        }

        .flatpickr-day:hover,
        .flatpickr-day:focus {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--bg-tertiary);
        }

        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange,
        .flatpickr-day.selected:focus,
        .flatpickr-day.startRange:focus,
        .flatpickr-day.endRange:focus,
        .flatpickr-day.selected:hover,
        .flatpickr-day.startRange:hover,
        .flatpickr-day.endRange:hover {
            background: var(--accent-main);
            color: var(--bg-primary);
            border-color: var(--accent-main);
        }

        .flatpickr-day.today {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .flatpickr-day.today:hover {
            border-color: var(--accent-orange);
            background: var(--accent-orange);
            color: var(--bg-primary);
        }

        .flatpickr-time {
            background: var(--bg-tertiary);
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }

        .flatpickr-time input.flatpickr-hour,
        .flatpickr-time input.flatpickr-minute,
        .flatpickr-time input.flatpickr-second {
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            background: var(--bg-primary) !important;
            border-radius: 4px;
            padding: 5px;
            font-family: var(--font-code);
        }

        .flatpickr-time .flatpickr-am-pm {
            color: var(--text-primary);
            background: var(--bg-primary);
            padding: 8px;
        }

        .flatpickr-time .flatpickr-am-pm:hover,
        .flatpickr-time .flatpickr-am-pm:focus {
            background: var(--accent-main) !important;
            color: var(--bg-primary) !important;
        }

        .numInputWrapper:hover {
            background: var(--bg-tertiary);
        }

        .numInputWrapper span:hover {
            background: var(--bg-tertiary);
        }

        .numInputWrapper span.arrowUp:after {
            border-bottom-color: var(--accent-green);
        }

        .numInputWrapper span.arrowDown:after {
            border-top-color: var(--accent-red);
        }

        .slot-item.is-completed {
            border-left-color: var(--accent-green);
            background-color: #22302c;
        }

        .slot-details .status-completed {
            font-size: 0.9em;
            color: var(--accent-green);
            margin-top: 5px;
            font-style: italic;
        }

        .slot-details .status-completed strong {
            color: #9ECE6A;
        }

        #motivational-quote {
            font-size: 1.05em;
            padding: 12px 15px;
            background-color: rgba(var(--bg-tertiary-rgb, 59, 62, 77), 0.5);
            /* Use RGB for opacity */
            border-radius: var(--border-radius);
            border-left: 4px solid var(--accent-green);
            min-height: 1.5em;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }


        /* Responsive */
        @media (min-width: 769px) {

            /* Styles for larger screens */
            #header-secondary-content {
                flex-direction: row;
                /* Date and Stats side-by-side */
                justify-content: space-between;
                align-items: flex-start;
                /* Align items to the top */
            }

            #current-date-display-container {
                width: 100%;
                background-color: var(--bg-tertiary);
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                padding: 20px;
                /* Added padding for better spacing */
                box-sizing: border-box;

                /* --- Flexbox Centering --- */
                display: flex;
                justify-content: center;
                /* Horizontally center */
                align-items: center;
                /* Vertically center */

                /* Ensures it takes available vertical space */
                flex-grow: 1;
            }

            #teacher-stats-container {
                width: auto;
                /* Adjust width */
                max-width: 800px;
                /* Max width for stats block - INCREASED for new stats */
                justify-content: flex-end;
            }

            .stat-item {
                min-width: 120px;
                /* Adjust min-width for side-by-side */
            }
        }

        @media (max-width: 768px) {
            body {
                padding-top: 10px;
            }

            .container {
                width: 95%;
                padding: 15px;
                margin: 10px auto;
            }

            #app-header h1 {
                font-size: 1.8rem;
                text-align: center;
            }

            #header-main-content {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            #current-date-display {
                font-size: 1.1rem;
                font-size: 1.3rem;
                font-weight: 600;
                color: var(--text-primary);
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.8rem;
                /* Slightly smaller for a cleaner look */
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.8px;
                /* Wider spacing looks more professional */
                font-weight: 500;
                /* A slightly bolder weight */
            }

            .stat-item {
                min-width: 100px;
                padding: 10px 15px;
                flex-basis: calc(50% - 10px);
            }

            /* FIXED: Mobile week navigation with proper day tab sizing */
            #week-navigation {
                gap: 8px;
                margin-bottom: 1.5rem;
                align-items: center;
                justify-content: space-between;
                padding: 10px 5px;
            }

            /* Navigation arrows - fixed sizing for mobile */
            .nav-arrow {
                flex-shrink: 0;
                width: 40px !important;
                height: 40px !important;
                min-width: 40px;
                padding: 8px !important;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 5px;
            }

            /* Week selector container */
            #week-selector {
                flex: 1;
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                justify-content: flex-start;
                gap: 4px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding: 5px 0;
                margin: 0 5px;
            }

            #week-selector::-webkit-scrollbar {
                display: none;
            }

            /* Day tab buttons - properly sized for mobile */
            #week-selector button {
                flex-shrink: 0;
                min-width: 85px;
                max-width: 85px;
                font-size: 0.8rem;
                padding: 8px 6px;
                line-height: 1.2;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                scroll-snap-align: start;
            }

            #week-selector button .date-small {
                font-size: 0.7em;
                display: block;
                margin-top: 2px;
            }

            .slots-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .slot-item {
                padding: 15px;
            }

            .modal-content {
                padding: 20px;
                max-height: 85vh;
                overflow-y: auto;
            }

            .modal-header h3 {
                font-size: 1.4rem;
            }

            #day-schedule-view .mb-2 {
                flex-direction: column;
                align-items: center;
            }

            #day-schedule-view .mb-2>h2#day-title {
                width: 100%;
                text-align: center;
                margin-bottom: 15px;
                font-size: 1.5rem;
            }

            #day-schedule-view .mb-2>div {
                /* Button container */
                justify-content: center;
                width: 100%;
                gap: 10px;
            }

            #add-slot-button {
                width: 100%;
            }

            /* --- IMPROVEMENT: Larger, more tappable buttons inside class slots --- */
            .slot-actions {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: flex-end;
                margin-top: 1.25rem;
                gap: 8px;
            }

            .slot-actions button {
                flex-grow: 1;
                flex-basis: auto;
                font-size: 0.85rem;
                padding: 8px 10px;
            }

            #schedule-announcement {
                font-size: 0.85em;
                padding: 12px 15px;
            }

            #motivational-quote {
                font-size: 0.95em;
                padding: 10px 12px;
            }
        }

        @media (max-width: 480px) {

            /* STYLES FOR THE SMALLEST SCREENS */
            input[type="text"],
            input[type="email"],
            input[type="password"],
            select,
            button,
            input.flatpickr-input {
                font-size: 1rem;
                width: calc(100% - 24px);
                box-sizing: border-box;
            }

            .time-inputs-container {
                flex-direction: column;
                gap: 0;
                width: 100%;
            }

            .time-inputs-container>div {
                width: 100%;
                margin-bottom: 1rem;
            }

            .time-inputs-container>div:last-child {
                margin-bottom: 0;
            }

            #auth-view h1 {
                font-size: 1.8rem;
            }

            #auth-view h2 {
                font-size: 1.3rem;
            }

            button,
            .btn {
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            #teacher-stats-container {
                flex-direction: column;
            }

            .stat-item {
                width: 100%;
                min-width: unset;
                flex-basis: 100%;
            }

            #app-header h1 {
                font-size: 1.6rem;
            }

            #current-date-display {
                font-size: 1rem;
            }

            #day-schedule-view h2#day-title {
                font-size: 1.4rem;
            }

            .slot-details .topic {
                font-size: 1.1em;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .modal-header h3 {
                font-size: 1.3rem;
            }

            /* Extra small screens - further optimize day tabs */
            #week-navigation {
                padding: 8px 2px;
                gap: 6px;
            }

            .nav-arrow {
                width: 35px !important;
                height: 35px !important;
                min-width: 35px;
                padding: 6px !important;
                margin: 0 3px;
            }

            #week-selector {
                margin: 0 3px;
                gap: 3px;
            }

            #week-selector button {
                min-width: 75px;
                max-width: 75px;
                font-size: 0.75rem;
                padding: 6px 4px;
            }

            #week-selector button .date-small {
                font-size: 0.65em;
            }
        }

        #schedule-announcement {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border-left: 5px solid var(--accent-yellow);
            padding: 15px 20px;
            margin-bottom: 2rem;
            /* Adds space below the announcement */
            border-radius: var(--border-radius);
            font-size: 0.95em;
            text-align: center;
            line-height: 1.6;
        }

        #schedule-announcement strong {
            color: var(--accent-yellow);
        }

        /* --- Add this for the login button loader --- */
        .btn .loader {
            width: 18px;
            height: 18px;
            border: 2px solid var(--bg-primary);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- End of new CSS --- */

        /* Additional Mobile Responsiveness Fixes */
        @media (max-width: 768px) {

            /* Fix for flatpickr calendar on mobile */
            .flatpickr-calendar {
                width: 95% !important;
                max-width: 350px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
            }

            /* Fix for notifications on small screens */
            #notifications {
                bottom: 15px;
                right: 15px;
                max-width: calc(100% - 30px);
            }

            .notification {
                padding: 12px 15px;
                font-size: 0.9rem;
                max-width: 100%;
            }
        }

        /* Fix for any potential horizontal scroll issues */
        html,
        body {
            max-width: 100%;
            overflow-x: hidden;
        }

        .license-info {
            display: block;
            /* Give it its own line */
            margin-top: 10px;
            /* Add space above it */
            padding: 6px 12px;
            /* Add some internal padding */
            background-color: var(--bg-tertiary);
            /* Use a slightly different background */
            border: 1px solid var(--accent-yellow);
            /* Bright yellow border */
            border-radius: var(--border-radius);
            color: var(--accent-yellow) !important;
            /* Bright yellow text */
            font-weight: 600;
            /* Make it bolder */
            font-size: 1em;
            /* Increase font size slightly */
            text-align: center;
            /* Center the license text */
            letter-spacing: 0.5px;
            box-shadow: 0 0 10px rgba(224, 175, 104, 0.2);
            /* Add a subtle glow */
        }

        /* ================================================================= */
        /* START: NEW CSS FOR LICENSE TIMELINE */
        /* ================================================================= */
        #license-timeline-view {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .license-timeline-title {
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #license-timeline-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }

        .license-row {
            display: flex;
            align-items: center;
            gap: 15px;
            height: 35px;
        }

        .license-label {
            font-family: var(--font-code);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            width: 100px;
            flex-shrink: 0;
            text-align: right;
        }

        .timeline-bar {
            flex-grow: 1;
            height: 100%;
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
            position: relative;
            /* START: MODIFICATION - Removed overflow: hidden to allow tooltip visibility */
            /* overflow: hidden; */
            /* END: MODIFICATION */
        }

        .timeline-slot {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: var(--accent-orange);
            /* Default for other teachers */
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.2);
        }

        .timeline-slot:hover {
            transform: scaleY(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .timeline-slot.is-own {
            background-color: var(--accent-main);
            /* Blue for my classes */
        }

        .timeline-slot.is-cancelled {
            background-color: var(--accent-red);
            opacity: 0.6;
        }

        .timeline-slot::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            white-space: pre;
            font-size: 0.8rem;
            line-height: 1.4;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 100;
            pointer-events: none;
        }

        .timeline-slot:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .timeline-axis {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-code);
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 115px;
            /* Align with timeline bars */
            padding-top: 5px;
            border-top: 1px solid var(--border-color);
            margin-top: 10px;
        }

        @media(max-width: 768px) {
            .license-label {
                width: 60px;
                font-size: 0.8rem;
            }

            .timeline-axis {
                margin-left: 75px;
            }

            .license-timeline-title {
                font-size: 1.1rem;
            }
        }

        /* ================================================================= */
        /* END: NEW CSS FOR LICENSE TIMELINE */
        /* ================================================================= */


        /* ================================================================= */
        /* START: NEW CSS FOR TEACHER OVERVIEW */
        /* ================================================================= */
        #teacher-overview-view {
            width: 100%;
        }

        #overview-navigation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 1.5rem;
        }

        #overview-week-display {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-secondary);
            text-align: center;
            flex-grow: 1;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            /* Teacher Name | 7 Days */
            gap: 5px;
            overflow-x: auto;
            /* Allow horizontal scroll on smaller screens */
            padding-bottom: 10px;
        }

        .overview-header,
        .overview-teacher-name,
        .overview-day-cell {
            background-color: var(--bg-tertiary);
            padding: 12px;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-align: center;
        }

        .overview-header {
            color: var(--accent-secondary);
            position: sticky;
            /* Make headers stick when scrolling */
            top: 0;
            z-index: 10;
        }

        .overview-teacher-name {
            color: var(--accent-main);
            background-color: #313442;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 10;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .overview-day-cell {
            background-color: rgba(var(--bg-primary-rgb, 26, 27, 38), 0.5);
            border: 1px solid var(--border-color);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
            padding: 8px;
            text-align: left;
            font-weight: 400;
        }

        .overview-day-cell.is-today {
            border-color: var(--accent-orange);
            box-shadow: 0 0 10px rgba(224, 175, 104, 0.2);
        }

        .overview-day-cell .day-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .overview-day-cell .day-header .class-count {
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .overview-slot {
            background-color: var(--bg-tertiary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            width: 100%;
            box-sizing: border-box;
            border-left: 3px solid var(--accent-main);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .overview-slot:hover {
            background-color: var(--accent-main);
            color: var(--bg-primary);
            transform: translateX(3px);
        }

        .overview-slot-time {
            font-weight: 600;
            font-family: var(--font-code);
        }

        .overview-slot.is-cancelled {
            border-left-color: var(--accent-red);
            opacity: 0.6;
            text-decoration: line-through;
        }

        .overview-slot.is-completed {
            border-left-color: var(--accent-green);
        }

        #overview-loader {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-secondary);
            padding: 40px;
        }

        /* ================================================================= */
        /* END: NEW CSS FOR TEACHER OVERVIEW */
        /* ================================================================= */

        /* ================================================================= */
        /* START: NEW CSS FOR SALARY HIGHLIGHT & HISTORY */
        /* ================================================================= */

        #salary-highlight-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            background-color: #2a3a3a;
            /* A calming dark green */
            border: 1px solid var(--accent-green);
            border-radius: var(--border-radius);
            padding: 20px 25px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(158, 206, 106, 0.15);
            transition: all 0.3s ease;
        }

        #salary-highlight-box .salary-icon {
            font-size: 2.5rem;
            line-height: 1;
        }

        #salary-highlight-box .salary-text {
            flex-grow: 1;
        }

        #salary-highlight-box .salary-text strong {
            display: block;
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        #salary-highlight-box .salary-text span {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        #salary-highlight-box #salary-highlight-amount {
            font-weight: 700;
            font-family: var(--font-code);
            color: var(--accent-green);
        }

        #salary-highlight-box #view-salary-history-button {
            flex-shrink: 0;
            /* Prevent button from shrinking */
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        #salary-highlight-box #view-salary-history-button:hover {
            background-color: var(--accent-green);
            color: var(--bg-primary);
            box-shadow: 0 0 15px rgba(158, 206, 106, 0.5);
        }

        /* Salary History Modal */
        #salary-history-list {
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 10px;
            /* For scrollbar */
        }

        .salary-history-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-secondary);
        }

        .salary-history-item:nth-child(even) {
            background-color: var(--bg-tertiary);
        }

        .salary-history-month {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .salary-history-amount {
            font-weight: 700;
            font-family: var(--font-code);
            color: var(--accent-green);
        }

        #salary-history-loader {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }



        /* Responsive adjustments */
        @media (max-width: 768px) {
            #salary-highlight-box {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding: 15px;
            }

            #salary-highlight-box .salary-text strong {
                font-size: 1.2rem;
            }

            #salary-highlight-box .salary-text span {
                font-size: 1rem;
            }

            #salary-highlight-box #view-salary-history-button {
                width: 100%;
            }
        }

        /* ADD THIS CSS SNIPPET */
        #pending-classes-warning {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border-left: 5px solid var(--accent-red);
            padding: 15px 20px;
            margin-bottom: 2rem;
            border-radius: var(--border-radius);
            font-size: 0.95em;
            text-align: center;
            line-height: 1.6;
        }

        #pending-classes-warning strong {
            color: var(--accent-red);
        }



        /* ================================================================= */
        /* END: UI FIX FOR SPLIT HEADER LAYOUT                             */
        /* ================================================================= */
        /* ================================================================= */
        /* START: PROFESSIONAL HEADER LAYOUT FIX                           */
        /* ================================================================= */

        /* This is the main container for the second row of the header */
        #header-secondary-content {
            display: flex;
            flex-direction: column;
            /* Mobile first: stack everything */
            gap: 1.25rem;
            width: 100%;
        }

        /* --- Left Side Column --- */
        #header-left-group {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            width: 100%;
        }

        /* --- Right Side Column --- */
        #all-stats-wrapper {
            width: 100%;
            /* ADDED: This will be the main card for the 4 stats */
            background-color: var(--bg-tertiary);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        /* --- The 4 Main Stats (Day's Completed, etc.) --- */
        /* MODIFIED: This is now a GRID for perfect 2x2 alignment */
        #teacher-stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* Creates two equal columns */
            gap: 15px;
            width: 100%;
        }

        /* --- The Cancellation Metric --- */
        #teacher-cancellation-metric {
            width: 100%;
            text-align: center;
            background-color: var(--bg-secondary);
            border: 1px solid var(--accent-orange);
            box-shadow: 0 0 15px rgba(224, 175, 104, 0.2);
            border-radius: var(--border-radius);
            padding: 20px;
            box-sizing: border-box;
            /* Ensures padding is included in width */
        }

        #teacher-cancellation-metric .metric-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        #teacher-cancellation-metric #cancellation-count {
            font-family: var(--font-code);
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-red);
            /* Changed to red for more impact */
            line-height: 1;
        }

        #teacher-cancellation-metric .metric-title {
            font-size: 1.1rem;
            /* Slightly adjusted for balance */
            font-weight: 500;
            color: var(--text-primary);
            text-align: left;
        }

        #teacher-cancellation-metric .metric-context {
            font-size: 0.8rem;
            /* Slightly smaller for a cleaner look */
            color: var(--text-muted);
            max-width: 450px;
            margin: 0 auto;
            line-height: 1.6;
        }


        /* --- Desktop Layout (The Core Fix) --- */
        @media (min-width: 992px) {

            /* Increased breakpoint for a better layout */
            #header-secondary-content {
                flex-direction: row;
                /* Puts left and right columns side-by-side */
                align-items: stretch;
                /* KEY FIX: Makes both columns equal height */
                gap: 20px;
            }

            #header-left-group {
                width: 40%;
                /* Assign a width to the left column */
                flex-shrink: 0;
                /* Prevent it from shrinking */
            }

            #all-stats-wrapper {
                width: 60%;
                /* Assign remaining width to the right column */
                display: flex;
                /* Allows vertical centering of the grid inside */
                align-items: center;
            }
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 480px) {
            #teacher-cancellation-metric .metric-main {
                flex-direction: column;
                gap: 5px;
            }

            #teacher-cancellation-metric #cancellation-count {
                font-size: 2.5rem;
            }

            #teacher-cancellation-metric .metric-title {
                font-size: 1rem;
                text-align: center;
            }

            /* Makes stats stack vertically on very small screens */
            #teacher-stats-container {
                grid-template-columns: 1fr;
            }
        }

        /* ================================================================= */
        /* END: PROFESSIONAL HEADER LAYOUT FIX                             */
        /* ================================================================= */
        /* ADD THIS ENTIRE CSS BLOCK */
        /* --- Notification Bell in Header --- */
        #notification-bell {
            position: relative;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease;
        }

        #notification-bell:hover {
            color: var(--accent-main);
        }

        #notification-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background-color: var(--accent-red);
            border-radius: 50%;
            border: 2px solid var(--bg-secondary);
            box-shadow: 0 0 8px rgba(247, 118, 142, 0.7);
            display: none;
            /* Hidden by default */
            animation: pulse 1.5s infinite;
        }

        #notification-dot.visible {
            display: block;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(247, 118, 142, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(247, 118, 142, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(247, 118, 142, 0);
            }
        }

        /* --- Announcement Modal (for Teachers) --- */
        #announcement-modal .modal-content {
            max-width: 600px;
            text-align: center;
        }

        #announcement-modal-icon {
            font-size: 3rem;
            color: var(--accent-yellow);
            margin-bottom: 1rem;
            line-height: 1;
        }

        #announcement-modal-body {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            max-height: 50vh;
            overflow-y: auto;
            text-align: left;
            background-color: var(--bg-primary);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        #announcement-modal-timestamp {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 1.5rem;
            font-style: italic;
        }

        /* --- Admin Announcement Modal --- */
        #admin-announcement-modal textarea {
            width: calc(100% - 24px);
            min-height: 200px;
            padding: 12px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: var(--font-primary);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
        }

        #admin-announcement-modal textarea:focus {
            outline: none;
            border-color: var(--accent-main);
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.3);
        }

        /* ================================================================= */
        /* START: CSS FOR ANNOUNCEMENT HISTORY                             */
        /* ================================================================= */
        .announcement-history-item {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-secondary);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 12px;
        }

        .announcement-history-item.is-deleted {
            border-left-color: var(--accent-red);
            opacity: 0.6;
        }

        .announcement-history-item .announcement-content {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
            /* Preserves line breaks from textarea */
        }

        .announcement-history-item .announcement-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
            border-top: 1px dashed var(--border-color);
            padding-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .announcement-history-item .admin-actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .announcement-history-item .admin-actions button {
            font-size: 0.8rem;
            padding: 5px 10px;
        }

        /* ================================================================= */
        /* END: CSS FOR ANNOUNCEMENT HISTORY                               */
        /* ================================================================= */

        /* ================================================================= */
        /* START: CSS FOR STUDENT DASHBOARD                                  */
        /* ================================================================= */
        #student-dashboard {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1.5rem;
            animation: fadeIn 0.5s ease;
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .student-header .welcome-text {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .student-header .welcome-text span {
            color: var(--accent-secondary);
        }

        .student-header .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .student-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .student-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .student-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .student-stat-card .stat-icon {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .student-stat-card .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-secondary);
            font-family: 'Fira Code', monospace;
        }

        .student-stat-card .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .student-main-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .student-main-grid {
                grid-template-columns: 1fr;
            }

            .student-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .student-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        .student-calendar-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.25rem;
        }

        .student-calendar-panel .flatpickr-calendar {
            width: 100% !important;
            box-shadow: none !important;
            background: transparent !important;
        }

        .student-calendar-panel .flatpickr-day.has-class {
            background: rgba(78, 205, 196, 0.2);
            border-color: var(--accent-secondary);
        }

        .student-calendar-panel .flatpickr-day.has-assignment {
            position: relative;
        }

        .student-calendar-panel .flatpickr-day.has-assignment::after {
            content: '';
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background: var(--accent-orange);
            border-radius: 50%;
        }

        .student-right-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .student-panel-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.25rem;
        }

        .student-panel-card h3 {
            font-size: 1.1rem;
            color: var(--accent-secondary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .class-event-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 0.9rem 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--accent-secondary);
            transition: all 0.2s ease;
        }

        .class-event-card:hover {
            transform: translateX(4px);
            background: rgba(78, 205, 196, 0.08);
        }

        .class-event-card .event-time {
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            color: var(--accent-secondary);
            font-weight: 600;
        }

        .class-event-card .event-topic {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 0.2rem;
        }

        .class-event-card .event-teacher {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.15rem;
        }

        .assignment-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 0.9rem 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--accent-orange);
            transition: all 0.2s ease;
        }

        .assignment-card:hover {
            transform: translateX(4px);
            background: rgba(255, 167, 38, 0.08);
        }

        .assignment-card .assignment-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .assignment-card .assignment-due {
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            color: var(--accent-orange);
            margin-top: 0.2rem;
        }

        .assignment-card .assignment-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.3rem;
            line-height: 1.4;
        }

        .assignment-card .assignment-teacher {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 0.3rem;
            font-style: italic;
        }

        .attendance-bar-container {
            background: var(--bg-primary);
            border-radius: 10px;
            height: 14px;
            overflow: hidden;
            margin: 0.75rem 0;
        }

        .attendance-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(90deg, var(--accent-green), var(--accent-secondary));
        }

        .attendance-bar.low {
            background: linear-gradient(90deg, var(--accent-red), var(--accent-orange));
        }

        .attendance-log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
        }

        .attendance-log-item .att-date {
            color: var(--text-muted);
        }

        .attendance-log-item .att-status {
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.78rem;
            font-weight: 600;
        }

        .att-status.present {
            background: rgba(76, 175, 80, 0.2);
            color: var(--accent-green);
        }

        .att-status.absent {
            background: rgba(244, 67, 54, 0.2);
            color: var(--accent-red);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .empty-state .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .day-classes-header {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .day-classes-header .selected-date-text {
            color: var(--accent-secondary);
        }

        /* ================================================================= */
        /* END: CSS FOR STUDENT DASHBOARD                                    */
        /* ================================================================= */
    </style>

</head>

<body>

    <div id="auth-view" class="container">
        <h1 class="text-center mb-3">Class Scheduler</h1>
        <div id="login-form">
            <h2 class="text-center mb-2">Login</h2>
            <label for="login-email">Email Address</label>
            <input type="email" id="login-email" placeholder="e.g., teacher@example.com" required class="mb-1">
            <label for="login-password">Password</label>
            <input type="password" id="login-password" placeholder="Enter your password" required class="mb-2">
            <button id="login-button" class="btn btn-primary" style="width:100%;">Login Securely</button>
        </div>

    </div>

    <div id="app-view" class="container hidden">
        <header id="app-header">
            <div id="header-main-content">
                <h1 id="main-title">Weekly Schedule</h1>
                <div id="user-info">
                    <span id="user-display-name"></span>
                    <button id="notification-bell" title="View Announcements" class="hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z" />
                        </svg>
                        <span id="notification-dot"></span>
                    </button>
                    <button id="manage-announcements-button" class="btn btn-warning hidden">Manage
                        Announcements</button>
                    <button id="manage-teachers-button" class="btn btn-primary hidden"
                        onclick="openTeacherManagementModal()"> Manage Teachers</button>
                    <button id="manage-students-button" class="btn btn-primary hidden"
                        onclick="openStudentManagementModal()"> Manage Students</button>
                    <button id="teacher-overview-button" class="btn btn-secondary hidden">Teacher Overview</button>
                    <button id="logout-button" class="btn btn-outline-primary">Logout</button>
                </div>
            </div>


            <div id="header-secondary-content">
                <div id="header-left-group">
                    <div id="current-date-display-container">
                        <div id="current-date-display">Loading date...</div>
                    </div>
                    <div id="teacher-cancellation-metric" class="hidden">
                        <div class="metric-main">
                            <span id="cancellation-count">0</span>
                            <span class="metric-title">Classes Cancelled This Month</span>
                        </div>
                        <div class="metric-context">
                            This is a key performance indicator. Strive to keep this number low.
                        </div>
                    </div>
                </div>

                <div id="all-stats-wrapper">
                    <div id="teacher-stats-container">
                        <div class="stat-item">
                            <span class="stat-value" id="stats-selected-day">0</span>
                            <span class="stat-label">CLASSES COMPLETED TODAY</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="stats-current-month">0</span>
                            <span class="stat-label">CLASSES THIS MONTH</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value earnings" id="stats-today-earnings">0</span>
                            <span class="stat-label">Today's Earnings</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value earnings" id="stats-monthly-earnings">0</span>
                            <span class="stat-label">Monthly Earnings</span>
                        </div>
                    </div>
                </div>
            </div>


        </header>

        <div id="main-schedule-content">
            <div id="salary-highlight-box" class="hidden">
                <div class="salary-icon"></div>
                <div class="salary-text">
                    <strong id="salary-highlight-title">Your salary is being released today!</strong>
                    <span id="salary-highlight-details">Total earnings for last month: <span
                            id="salary-highlight-amount">0</span></span>
                </div>
                <button id="view-salary-history-button" class="btn btn-outline-primary">View History</button>
            </div>

            <div id="pending-classes-warning" class="hidden">
                <strong>Action Required:</strong> You have unmarked classes on the following date(s): <strong
                    id="warning-dates" style="color: var(--text-primary);"></strong>. Please update their status to
                ensure your salary is calculated correctly.
            </div>

            <div id="schedule-announcement">
                <strong>Friendly Reminder:</strong> Please finalize your schedule before <strong>10:00 AM</strong>. This
                helps everyone organize their day effectively.
            </div>

            <div id="week-navigation">
                <button id="prev-week-button" class="btn nav-arrow" title="Previous Week">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z" />
                    </svg>
                </button>
                <div id="week-selector"></div>
                <button id="next-week-button" class="btn nav-arrow" title="Next Week">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z" />
                    </svg>
                </button>
            </div>


            <div id="day-schedule-view" class="hidden">
                <hr class="mb-2 mt-2" style="border-color: var(--border-color);">
                <p id="motivational-quote" class="text-center mt-1 mb-2"
                    style="color: var(--accent-green); font-style: italic; min-height: 1.5em;"></p>
                <div style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;"
                    class="mb-2">
                    <h2 id="day-title" style="margin-bottom: 0;"></h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; flex-grow: 1;">
                        <button id="add-slot-button" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-plus-lg" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
                            </svg>
                            Add Class Slot
                        </button>
                    </div>
                </div>

                <div id="license-timeline-view">
                    <h3 class="license-timeline-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z" />
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z" />
                        </svg>
                        License Availability for the Day
                    </h3>
                    <div id="license-timeline-container">
                    </div>
                    <div class="timeline-axis">
                        <span>6AM</span><span>7AM</span><span>8AM</span><span>9AM</span><span>10AM</span><span>11AM</span><span>12PM</span><span>1PM</span><span>2PM</span><span>3PM</span><span>4PM</span><span>5PM</span><span>6PM</span><span>7PM</span><span>8PM</span><span>9PM</span><span>10PM</span><span>11PM</span><span>12AM</span><span>1AM</span>
                    </div>
                </div>
                <div id="slots-list" class="mt-2"></div>

                <p id="no-slots-message" class="text-center hidden mt-3"
                    style="font-style: italic; color: var(--text-muted);">No classes scheduled for this day. Enjoy your
                    free time or add a new class!</p>
            </div>
        </div>

        <div id="teacher-overview-view" class="hidden">
            <div id="overview-navigation">
                <button id="overview-prev-week-button" class="btn nav-arrow" title="Previous Week">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z" />
                    </svg>
                </button>
                <div id="overview-week-display">Loading...</div>
                <button id="overview-next-week-button" class="btn nav-arrow" title="Next Week">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z" />
                    </svg>
                </button>
            </div>
            <div id="overview-grid-container">
                <div id="overview-loader">Fetching schedule data...</div>
            </div>
        </div>
    </div>

    <div id="slot-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Class Slot</h3>
                <button class="close-button" id="close-modal-button">&times;</button>
            </div>
            <input type="hidden" id="slot-id">

            <div id="teacher-select-container-for-admin" class="hidden mb-2">
                <label for="modal-teacher-select">Assign to Teacher:</label>
                <select id="modal-teacher-select" required class="mb-1" style="width: 100%;"></select>
            </div>

            <div id="modal-tag-container" class="hidden mb-2">
                <label for="modal-tag-select">Class Type (Compulsory):</label>
                <select id="modal-tag-select" style="width: 100%;">
                    <option value="none">Not Specified</option>
                    <option value="group">Group Class (200)</option>
                    <option value="personalized">Personalized Class (125)</option>
                </select>
            </div>

            <div id="apply-tag-to-future-container" class="hidden mb-2"
                style="display: flex; align-items: center; background-color: var(--bg-primary); padding: 12px; border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                <input type="checkbox" id="apply-tag-to-future-checkbox">
                <label for="apply-tag-to-future-checkbox"
                    style="margin-bottom: 0; font-weight: normal; user-select: none;">Apply this tag to all future
                    classes in this series</label>
            </div>
            <div class="time-inputs-container">
                <div>
                    <label for="start-time">Start Time:</label>
                    <input type="text" id="start-time" placeholder="Select start time" required>
                </div>
                <div>
                    <label for="duration-select">Duration:</label>
                    <select id="duration-select" required>
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60" selected>1 hour</option>
                        <option value="75">1 hour 15 minutes</option>
                        <option value="90">1 hour 30 minutes</option>
                        <option value="105">1 hour 45 minutes</option>
                        <option value="120">2 hours</option>
                        <option value="150">2 hours 30 minutes</option>
                        <option value="180">3 hours</option>
                    </select>
                </div>
            </div>
            <label for="topic">Topic / Subject:</label>
            <input type="text" id="topic"
                placeholder="e.g., Comet Coders grade 8,Personalized class of Arav,Maths classes of .." required
                class="mb-2">

            <div id="recurring-container" class="mb-2" style="display: flex; align-items: center; margin-top: 1rem;">
                <input type="checkbox" id="recurring-checkbox">
                <label for="recurring-checkbox" style="margin-bottom: 0; font-weight: normal; user-select: none;">Repeat
                    this class every week</label>
            </div>

            <button id="save-slot-button" class="btn btn-success" style="width:100%;">Save Slot</button>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="delete-modal-title">Confirm Deletion</h3>
                <button class="close-button" id="close-delete-modal-button">&times;</button>
            </div>
            <p id="delete-modal-message" class="mb-2">Are you sure you want to permanently delete this class slot?</p>

            <div id="delete-options-container" class="hidden mb-2">
                <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                    <input type="radio" id="delete-option-single" name="delete-option" value="single" checked>
                    <label for="delete-option-single" style="margin-bottom: 0; font-weight: normal;">Delete only this
                        instance</label>
                </div>
                <div style="display: flex; align-items: center;">
                    <input type="radio" id="delete-option-future" name="delete-option" value="future">
                    <label for="delete-option-future" style="margin-bottom: 0; font-weight: normal;">Delete this and all
                        future instances</label>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem;">
                <button id="cancel-delete-button" class="btn btn-secondary">Cancel</button>
                <button id="confirm-delete-button" class="btn btn-danger">Confirm Deletion</button>
            </div>
        </div>
    </div>

    <div id="salary-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Salary History</h3>
                <button class="close-button" id="close-salary-history-modal-button">&times;</button>
            </div>
            <p class="text-muted mb-2">Showing total earnings for completed classes for each of the last 12 months.</p>
            <div id="salary-history-list">
                <div id="salary-history-loader" class="hidden">Loading history...</div>
            </div>
        </div>
    </div>
    <div id="notifications"></div>


    <div id="announcement-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>All Announcements</h3>
                <button class="close-button" id="close-announcement-modal-button">&times;</button>
            </div>
            <div id="teacher-announcements-list" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
            </div>
        </div>
    </div>


    <div id="admin-announcements-manager-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Announcements</h3>
                <button class="close-button" id="close-admin-manager-modal-button">&times;</button>
            </div>

            <div id="create-announcement-section"
                style="background-color: var(--bg-primary); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-bottom: 2rem;">
                <h4
                    style="color: var(--accent-secondary); margin-top: 0; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">
                    Create New Announcement</h4>
                <p style="color: var(--text-muted); margin-top: -0.5rem; margin-bottom: 1.5rem; font-size: 0.9em;">This
                    message will be pushed to all teachers and added to the history below.</p>
                <label for="new-announcement-textarea">Announcement Message:</label>
                <textarea id="new-announcement-textarea" placeholder="Type your message here..."></textarea>
                <button id="publish-new-announcement-button" class="btn btn-success" style="width:100%;">Publish New
                    Announcement</button>
            </div>

            <h4 style="color: var(--accent-secondary); margin-top: 0; margin-bottom: 1rem;">Announcement History</h4>
            <div id="announcements-history-list" style="max-height: 40vh; overflow-y: auto; padding-right: 10px;">
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ADMIN: TEACHER MANAGEMENT MODAL -->
    <!-- ============================================ -->
    <div id="teacher-management-modal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h3> Manage Teachers</h3>
                <button class="close-button" id="close-teacher-modal-button">&times;</button>
            </div>

            <!-- Create New Teacher Section -->
            <div id="create-teacher-section"
                style="background-color: var(--bg-primary); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-bottom: 2rem;">
                <h4
                    style="color: var(--accent-green); margin-top: 0; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">
                     Add New Teacher
                </h4>
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label for="new-teacher-name">Teacher Name:</label>
                        <input type="text" id="new-teacher-name" placeholder="Enter full name" required>
                    </div>
                    <div>
                        <label for="new-teacher-email">Email Address:</label>
                        <input type="email" id="new-teacher-email" placeholder="teacher@example.com" required>
                    </div>
                    <div>
                        <label for="new-teacher-password">Password:</label>
                        <input type="password" id="new-teacher-password" placeholder="Minimum 6 characters" required>
                    </div>
                    <button id="create-teacher-button" class="btn btn-success" style="width:100%;">
                        Create Teacher Account
                    </button>
                </div>
            </div>

            <!-- Existing Teachers List -->
            <h4 style="color: var(--accent-secondary); margin-top: 0; margin-bottom: 1rem;">
                 Existing Teachers
            </h4>
            <div id="teachers-list" style="max-height: 40vh; overflow-y: auto; padding-right: 10px;">
                <div id="teachers-loader" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    Loading teachers...
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ADMIN: STUDENT MANAGEMENT MODAL -->
    <!-- ============================================ -->
    <div id="student-management-modal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h3> Manage Students</h3>
                <button class="close-button" id="close-student-modal-button">&times;</button>
            </div>

            <!-- Create New Student Section -->
            <div id="create-student-section"
                style="background-color: var(--bg-primary); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-bottom: 2rem;">
                <h4
                    style="color: var(--accent-green); margin-top: 0; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">
                     Add New Student
                </h4>
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label for="new-student-name">Student Name:</label>
                        <input type="text" id="new-student-name" placeholder="Enter full name" required>
                    </div>
                    <div>
                        <label for="new-student-email">Email Address:</label>
                        <input type="email" id="new-student-email" placeholder="student@example.com" required>
                    </div>
                    <div>
                        <label for="new-student-password">Password:</label>
                        <input type="password" id="new-student-password" placeholder="Minimum 6 characters" required>
                    </div>
                    <div>
                        <label for="new-student-batches">Batches (comma-separated):</label>
                        <input type="text" id="new-student-batches" placeholder="e.g., Grade 8, Python Batch">
                    </div>
                    <button id="create-student-button" class="btn btn-success" style="width:100%;">
                        Create Student Account
                    </button>
                </div>
            </div>

            <!-- Existing Students List -->
            <h4 style="color: var(--accent-secondary); margin-top: 0; margin-bottom: 1rem;">
                 Existing Students
            </h4>
            <div id="students-list" style="max-height: 40vh; overflow-y: auto; padding-right: 10px;">
                <div id="students-loader" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    Loading students...
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- TEACHER: ASSIGNMENT MODAL -->
    <!-- ============================================ -->
    <div id="assignment-modal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3> Post Assignment / Homework</h3>
                <button class="close-button" id="close-assignment-modal-button">&times;</button>
            </div>
            <div style="display: grid; gap: 1rem;">
                <div>
                    <label for="assignment-title">Title:</label>
                    <input type="text" id="assignment-title" placeholder="e.g., Chapter 5 Exercises" required>
                </div>
                <div>
                    <label for="assignment-description">Description:</label>
                    <textarea id="assignment-description" placeholder="Describe the assignment..." rows="3"></textarea>
                </div>
                <div>
                    <label for="assignment-due-date">Due Date:</label>
                    <input type="text" id="assignment-due-date" placeholder="Select date" required>
                </div>
                <div>
                    <label for="assignment-batch">Batch / Class:</label>
                    <input type="text" id="assignment-batch" placeholder="e.g., Grade 8, Python Batch">
                </div>
                <button id="save-assignment-button" class="btn btn-success" style="width:100%;">Post Assignment</button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- STUDENT DASHBOARD (shown for student role) -->
    <!-- ============================================ -->
    <div id="student-dashboard" class="hidden">
        <div class="student-header">
            <div class="welcome-text"> Welcome, <span id="student-display-name">Student</span></div>
            <div class="header-actions">
                <button id="student-notification-bell" title="View Announcements" class="hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z" />
                    </svg>
                    <span id="student-notification-dot"></span>
                </button>
                <button id="student-logout-button" class="btn btn-outline-primary">Logout</button>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="student-stats-row">
            <div class="student-stat-card">
                <div class="stat-icon"></div>
                <div class="stat-number" id="student-today-classes">0</div>
                <div class="stat-label">Today's Classes</div>
            </div>
            <div class="student-stat-card">
                <div class="stat-icon"></div>
                <div class="stat-number" id="student-week-classes">0</div>
                <div class="stat-label">This Week</div>
            </div>
            <div class="student-stat-card">
                <div class="stat-icon"></div>
                <div class="stat-number" id="student-attendance-rate"></div>
                <div class="stat-label">Attendance Rate</div>
            </div>
            <div class="student-stat-card">
                <div class="stat-icon"></div>
                <div class="stat-number" id="student-pending-assignments">0</div>
                <div class="stat-label">Pending Tasks</div>
            </div>
        </div>

        <!-- Main Grid: Calendar + Content -->
        <div class="student-main-grid">
            <!-- Calendar Panel -->
            <div class="student-calendar-panel">
                <h3 style="color: var(--accent-secondary); margin-bottom: 1rem; font-size: 1rem;"> Calendar</h3>
                <div id="student-calendar-container"></div>
                <div id="student-day-events" style="margin-top: 1rem;">
                    <div class="day-classes-header"> <span class="selected-date-text"
                            id="student-selected-date-text">Select a date</span></div>
                    <div id="student-day-classes-list">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div>Click a date to see classes</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Upcoming + Assignments + Attendance -->
            <div class="student-right-panel">
                <!-- Upcoming Classes -->
                <div class="student-panel-card">
                    <h3> Upcoming Classes</h3>
                    <div id="student-upcoming-classes">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div>No upcoming classes</div>
                        </div>
                    </div>
                </div>

                <!-- Assignments -->
                <div class="student-panel-card">
                    <h3> Assignments & Homework</h3>
                    <div id="student-assignments-list">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div>No pending assignments</div>
                        </div>
                    </div>
                </div>

                <!-- Attendance -->
                <div class="student-panel-card">
                    <h3> Attendance</h3>
                    <div id="student-attendance-section">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-muted); font-size: 0.9rem;">Overall Attendance</span>
                            <span id="student-attendance-percent"
                                style="font-family: 'Fira Code', monospace; font-weight: 700; color: var(--accent-green);">%</span>
                        </div>
                        <div class="attendance-bar-container">
                            <div class="attendance-bar" id="student-attendance-bar" style="width: 0%;"></div>
                        </div>
                        <div id="student-attendance-log"
                            style="max-height: 200px; overflow-y: auto; margin-top: 0.5rem;">
                            <div class="empty-state" style="padding: 1rem;">No attendance records yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script type="module">
        // -----------------------------
        // FIREBASE CONFIG AND INIT
        // -----------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBrEYubOCWRP-Dowqo9AvxEGFRea1YQzl4",
            authDomain: "modernagecodersdashboard.firebaseapp.com",
            projectId: "modernagecodersdashboard",
            storageBucket: "modernagecodersdashboard.firebasestorage.app",
            messagingSenderId: "1038030973429",
            appId: "1:1038030973429:web:bbba63274daf2ce12d18bc"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            onAuthStateChanged, signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, query, where, onSnapshot,
            doc, updateDoc, deleteDoc, orderBy, setDoc, getDoc, getDocs, writeBatch,
            getCountFromServer, limit, serverTimestamp  // <-- IMPORT THE EFFICIENT COUNTER
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // -----------------------------
        // ZOOM API CONFIGURATION
        // -----------------------------
        // These settings control how Zoom license availability is checked
        const ZOOM_API_ENABLED = true;  // Set to false to use fallback (Firestore-only) mode
        const ZOOM_API_TIMEOUT = 10000; // 10 second timeout for API calls

        /**
         * Check Zoom license availability via backend API
         * Returns: { available: boolean|null, status: string, licenseId: number }
         */
        async function checkZoomLicenseAvailability(licenseId) {
            if (!ZOOM_API_ENABLED) {
                return { available: null, status: 'disabled', licenseId };
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), ZOOM_API_TIMEOUT);

            try {
                const response = await fetch('/api/check-license', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ licenseId }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    console.warn(`Zoom API error for license ${licenseId}:`, response.status);
                    return { available: null, status: 'api_error', licenseId };
                }

                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.warn(`Zoom API timeout for license ${licenseId}`);
                    return { available: null, status: 'timeout', licenseId };
                }
                console.error(`Error checking Zoom license ${licenseId}:`, error);
                return { available: null, status: 'error', licenseId, error: error.message };
            }
        }

        /**
         * Check all Zoom licenses at once via backend API
         * Returns: { licenses: Array, firstAvailable: number|null, allBusy: boolean }
         */
        async function checkAllZoomLicenses() {
            if (!ZOOM_API_ENABLED) {
                return { licenses: [], firstAvailable: null, allBusy: false, apiDisabled: true };
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), ZOOM_API_TIMEOUT);

            try {
                const response = await fetch('/api/check-all-licenses', {
                    method: 'GET',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    console.warn('Zoom API error:', response.status);
                    return { licenses: [], firstAvailable: null, allBusy: false, apiError: true };
                }

                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('Error checking all Zoom licenses:', error);
                return { licenses: [], firstAvailable: null, allBusy: false, apiError: true };
            }
        }

        /**
         * Find the first available license using Zoom API + Firestore hybrid approach
         * 1. First filters licenses by Firestore schedule (existing logic)
         * 2. Then verifies real-time availability via Zoom API
         * 3. Falls back to Firestore-only if API fails
         */
        async function findAvailableLicenseHybrid(usedLicenseIds) {
            // Step 1: Find licenses that are free in Firestore (no scheduled overlaps)
            const firestoreFreeLicenses = [];
            for (let i = 1; i <= TOTAL_LICENSES; i++) {
                if (!usedLicenseIds.has(i)) {
                    firestoreFreeLicenses.push(i);
                }
            }

            // If no licenses free in Firestore, return 0 (personal) immediately
            if (firestoreFreeLicenses.length === 0) {
                return { licenseId: 0, source: 'firestore', message: 'All licenses scheduled' };
            }

            // Step 2: Check Zoom API for real-time availability
            if (ZOOM_API_ENABLED) {
                try {
                    const zoomStatus = await checkAllZoomLicenses();

                    if (zoomStatus.apiError || zoomStatus.apiDisabled) {
                        // API failed, fall back to Firestore-only
                        console.warn('Zoom API unavailable, using Firestore-only mode');
                        return {
                            licenseId: firestoreFreeLicenses[0],
                            source: 'firestore_fallback',
                            message: 'Zoom API unavailable'
                        };
                    }

                    // Find a license that's free in BOTH Firestore AND Zoom
                    for (const licenseId of firestoreFreeLicenses) {
                        const zoomLicense = zoomStatus.licenses.find(l => l.licenseId === licenseId);

                        // If Zoom says available (or can't determine), use it
                        if (!zoomLicense || zoomLicense.available === true || zoomLicense.available === null) {
                            return {
                                licenseId,
                                source: 'zoom_verified',
                                zoomStatus: zoomLicense?.status || 'unknown'
                            };
                        }
                    }

                    // All Firestore-free licenses are busy in Zoom
                    return {
                        licenseId: 0,
                        source: 'zoom_all_busy',
                        message: 'All licenses are currently in active Zoom meetings'
                    };

                } catch (error) {
                    console.error('Error in hybrid license check:', error);
                    // Fall back to Firestore-only
                    return {
                        licenseId: firestoreFreeLicenses[0],
                        source: 'firestore_error_fallback'
                    };
                }
            }

            // Zoom API disabled - use Firestore only
            return {
                licenseId: firestoreFreeLicenses[0],
                source: 'firestore_only'
            };
        }

        // -----------------------------
        // DOM ELEMENTS
        // -----------------------------

        const TOTAL_LICENSES = 4;
        const BUFFER_BEFORE_MIN = 10;   // minutes BEFORE real start
        const BUFFER_AFTER_MIN = 15;   // minutes AFTER real end
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');

        const userDisplayName = document.getElementById('user-display-name');
        const logoutButton = document.getElementById('logout-button');
        const weekSelector = document.getElementById('week-selector');
        const prevWeekButton = document.getElementById('prev-week-button');
        const nextWeekButton = document.getElementById('next-week-button');
        const dayScheduleView = document.getElementById('day-schedule-view');
        const dayTitle = document.getElementById('day-title');
        const addSlotButton = document.getElementById('add-slot-button');
        const slotsList = document.getElementById('slots-list');
        const noSlotsMessage = document.getElementById('no-slots-message');
        const currentDateDisplay = document.getElementById('current-date-display');

        const slotModal = document.getElementById('slot-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModalButton = document.getElementById('close-modal-button');
        const slotIdInput = document.getElementById('slot-id');
        const startTimeInput = document.getElementById('start-time');
        const durationSelect = document.getElementById('duration-select');
        const topicInput = document.getElementById('topic');
        const saveSlotButton = document.getElementById('save-slot-button');
        const notificationsDiv = document.getElementById('notifications');
        const recurringContainer = document.getElementById('recurring-container');
        const recurringCheckbox = document.getElementById('recurring-checkbox');

        const statsSelectedDay = document.getElementById('stats-selected-day');
        const statsCurrentMonth = document.getElementById('stats-current-month');
        const motivationalQuoteEl = document.getElementById('motivational-quote');
        const authViewH1 = document.querySelector('#auth-view h1');

        const teacherSelectContainerAdmin = document.getElementById('teacher-select-container-for-admin');
        const modalTeacherSelect = document.getElementById('modal-teacher-select');

        // New DOM elements for Delete Modal
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const closeDeleteModalButton = document.getElementById('close-delete-modal-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const deleteOptionsContainer = document.getElementById('delete-options-container');
        const deleteModalMessage = document.getElementById('delete-modal-message');

        const modalTagContainer = document.getElementById('modal-tag-container');
        const modalTagSelect = document.getElementById('modal-tag-select');
        const statsTodayEarnings = document.getElementById('stats-today-earnings');
        const statsMonthlyEarnings = document.getElementById('stats-monthly-earnings');

        const applyTagToFutureContainer = document.getElementById('apply-tag-to-future-container');
        const applyTagToFutureCheckbox = document.getElementById('apply-tag-to-future-checkbox');

        // =================================================================
        // START: NEW DOM ELEMENTS FOR TEACHER OVERVIEW
        // =================================================================
        const mainTitle = document.getElementById('main-title');
        const teacherOverviewButton = document.getElementById('teacher-overview-button');
        const mainScheduleContent = document.getElementById('main-schedule-content');
        const teacherOverviewView = document.getElementById('teacher-overview-view');
        const overviewGridContainer = document.getElementById('overview-grid-container');
        const overviewPrevWeekButton = document.getElementById('overview-prev-week-button');
        const overviewNextWeekButton = document.getElementById('overview-next-week-button');
        const overviewWeekDisplay = document.getElementById('overview-week-display');
        // =================================================================
        // END: NEW DOM ELEMENTS FOR TEACHER OVERVIEW
        // =================================================================

        // =================================================================
        // START: NEW DOM ELEMENTS FOR SALARY FEATURE
        // =================================================================
        const salaryHighlightBox = document.getElementById('salary-highlight-box');
        const salaryHighlightAmount = document.getElementById('salary-highlight-amount');
        const viewSalaryHistoryButton = document.getElementById('view-salary-history-button');
        const salaryHistoryModal = document.getElementById('salary-history-modal');
        const closeSalaryHistoryModalButton = document.getElementById('close-salary-history-modal-button');
        const salaryHistoryList = document.getElementById('salary-history-list');
        const salaryHistoryLoader = document.getElementById('salary-history-loader');
        const pendingClassesWarning = document.getElementById('pending-classes-warning'); // <-- ADD THIS LINE

        const teacherCancellationMetric = document.getElementById('teacher-cancellation-metric');
        const cancellationCountEl = document.getElementById('cancellation-count');
        // ADD THESE NEW DOM ELEMENT VARIABLES

        const notificationBell = document.getElementById('notification-bell');
        const notificationDot = document.getElementById('notification-dot');
        const announcementModal = document.getElementById('announcement-modal');
        const closeAnnouncementModalButton = document.getElementById('close-announcement-modal-button');

        // --- START: NEW DOM ELEMENTS FOR ANNOUNCEMENT MANAGEMENT ---
        const manageAnnouncementsButton = document.getElementById('manage-announcements-button');
        const manageTeachersButton = document.getElementById('manage-teachers-button');
        const adminManagerModal = document.getElementById('admin-announcements-manager-modal');
        const closeAdminManagerModalButton = document.getElementById('close-admin-manager-modal-button');
        const newAnnouncementTextarea = document.getElementById('new-announcement-textarea');
        const publishNewAnnouncementButton = document.getElementById('publish-new-announcement-button');
        const announcementsHistoryList = document.getElementById('announcements-history-list');
        const teacherAnnouncementsList = document.getElementById('teacher-announcements-list');
        // --- END: NEW DOM ELEMENTS FOR ANNOUNCEMENT MANAGEMENT ---
        // =================================================================
        // END: NEW DOM ELEMENTS FOR SALARY FEATURE
        // =================================================================
        // ...inside the DOM ELEMENTS section

        // =================================================================

        let startTimePicker;

        // -----------------------------
        // GLOBAL STATE & FUNCTIONS
        // -----------------------------
        let unsubscribeAnnouncementListener = null;
        let currentUser = null;
        let currentTeacherName = ""; // This will include "(Admin)" suffix for admins
        let currentSelectedFullDate = null;
        let currentWeekStartDate = null; // To track the start of the displayed week
        let unsubscribeSlotsListener = null;
        const daysOfWeekDisplay = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        const GROUP_CLASS_EARNING = 200;
        const PERSONALIZED_CLASS_EARNING = 125;

        let longSessionMessageShownToday = false;
        const motivationalQuotes = [
            "The only way to do great work is to love what you do. Keep inspiring!",
            "Every class is a new adventure. Enjoy the journey!",
            "You're shaping the future, one class at a time. Amazing!",
            "Your energy and passion make all the difference. Shine on!",
            "Keep calm and teach on. You've got this!"
        ];

        let allTeachersData = []; // For admin to store teacher list {id, displayName, email, role}

        // =================================================================
        // START: NEW STATE FOR TEACHER OVERVIEW
        // =================================================================
        let overviewCurrentWeekStartDate = null;
        // =================================================================
        // END: NEW STATE FOR TEACHER OVERVIEW
        // =================================================================


        if (authViewH1) {
            authViewH1.innerHTML = 'Class Scheduler';
        }

        function getRgbFromCssVar(cssVarName) {
            const value = getComputedStyle(document.documentElement).getPropertyValue(cssVarName).trim();
            if (value.startsWith('#')) {
                const hex = value.substring(1);
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                return `${r}, ${g}, ${b}`;
            }
            return '59, 62, 77';
        }
        document.documentElement.style.setProperty('--bg-tertiary-rgb', getRgbFromCssVar('--bg-tertiary'));
        document.documentElement.style.setProperty('--bg-primary-rgb', getRgbFromCssVar('--bg-primary'));


        function getLocalDateString(dateObject) {
            if (!dateObject) return null;
            const year = dateObject.getFullYear();
            const month = String(dateObject.getMonth() + 1).padStart(2, '0');
            const day = String(dateObject.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // START: NEW - Helper function to format timestamps for display
        function formatTimestampForDisplay(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                // Format: 'Aug 5, 8:30 PM'
                return date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                console.error("Could not format timestamp:", e);
                return ''; // Return empty if the date is invalid
            }
        }
        // END: NEW

        // START: MODIFICATION - Time calculation helper functions
        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const formattedHours = String(hours % 24).padStart(2, '0'); // Use modulo 24 for times past midnight
            const formattedMinutes = String(minutes).padStart(2, '0');
            return `${formattedHours}:${formattedMinutes}`;
        }

        function calculateDisplayStartTime(startTimeStr) {
            if (!startTimeStr) return 'N/A';
            const startMinutes = timeToMinutes(startTimeStr);
            const displayStartMinutes = startMinutes - 10;
            return minutesToTime(displayStartMinutes);
        }

        function calculateDisplayEndTime(startTimeStr, endTimeStr) {
            if (!startTimeStr || !endTimeStr) return 'N/A';
            const startMinutes = timeToMinutes(startTimeStr);
            const endMinutes = timeToMinutes(endTimeStr);
            const duration = endMinutes - startMinutes;
            if (duration < 0) return endTimeStr; // Handle edge cases if data is incorrect
            const displayEndMinutes = startMinutes + duration + 15;
            return minutesToTime(displayEndMinutes);
        }
        // END: MODIFICATION

        function updateDateDisplay() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDateDisplay.textContent = now.toLocaleDateString('en-US', options);
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notificationsDiv.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function initializeTimePickers() {
            const commonOptions = {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                minuteIncrement: 15,
                theme: "dark"
            };
            if (startTimePicker) startTimePicker.destroy();
            startTimePicker = flatpickr(startTimeInput, commonOptions);
        }

        function calculateEndTime(startTimeStr, durationMinutes) {
            if (!startTimeStr || !startTimeStr.includes(':')) {
                console.error("Invalid startTimeStr format for calculateEndTime:", startTimeStr);
                showNotification("Invalid start time format selected.", "error");
                return null;
            }
            const [startHours, startMinutes] = startTimeStr.split(':').map(Number);

            if (isNaN(startHours) || isNaN(startMinutes) || isNaN(durationMinutes)) {
                console.error("Invalid numeric values for time calculation.");
                showNotification("Error in time calculation values.", "error");
                return null;
            }

            let totalMinutes = startHours * 60 + startMinutes + parseInt(durationMinutes);
            const endHours = Math.floor(totalMinutes / 60);
            const endMins = totalMinutes % 60;

            const formattedEndHours = String(endHours % 24).padStart(2, '0');
            const formattedEndMinutes = String(endMins).padStart(2, '0');

            return `${formattedEndHours}:${formattedEndMinutes}`;
        }

        // =================================================================
        // START: EFFICIENT DASHBOARD STATS LOGIC
        // =================================================================

        /**
         * Main function to update all dashboard stats panels.
         * Calls specific renderers that use efficient queries.
         */

        // ADD THIS NEW JAVASCRIPT FUNCTION
        // REPLACE the old function with this new one
        async function checkAndDisplayPendingClassesWarning() {
            if (!currentUser || currentUser.isAdmin) {
                pendingClassesWarning.classList.add('hidden');
                return;
            }

            const todayString = getLocalDateString(new Date());

            // We remove 'limit(1)' to get ALL past, scheduled classes
            const q = query(collection(db, "classSlots"),
                where("teacherId", "==", currentUser.uid),
                where("status", "==", "scheduled"),
                where("date", "<", todayString)
            );

            try {
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    pendingClassesWarning.classList.add('hidden');
                    return;
                }

                // Use a JavaScript Set to automatically handle unique dates
                const pendingDates = new Set();
                querySnapshot.forEach(doc => {
                    pendingDates.add(doc.data().date);
                });

                if (pendingDates.size > 0) {
                    // Convert the set of dates (e.g., "2025-08-18") into a user-friendly format (e.g., "August 18")
                    const formattedDates = [...pendingDates].map(dateStr => {
                        const dateObj = new Date(dateStr.replace(/-/g, '/')); // Use replace for better browser compatibility
                        return dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
                    });

                    // Join the formatted dates with a comma
                    const datesString = formattedDates.join(', ');

                    // Find our placeholder in the HTML and set its text content
                    const warningDatesElement = document.getElementById('warning-dates');
                    if (warningDatesElement) {
                        warningDatesElement.textContent = datesString;
                    }

                    // Finally, show the warning message
                    pendingClassesWarning.classList.remove('hidden');

                } else {
                    pendingClassesWarning.classList.add('hidden');
                }

            } catch (error) {
                console.error("Error checking for pending past classes:", error);
                pendingClassesWarning.classList.add('hidden');
            }
        }



        async function updateAllDashboardStats() {
            if (!currentUser || !currentSelectedFullDate) return;

            try {
                // Run both stats updates in parallel for speed
                await Promise.all([
                    renderTeacherStats(),
                    renderEarningsStats()
                ]);
            } catch (error) {
                console.error("Error updating dashboard stats:", error);
                showNotification("Could not update dashboard stats.", "error");
            }
        }

        /**
         * Renders completed class counts using efficient getCountFromServer queries.
         * This avoids downloading the actual documents.
         */
        async function renderTeacherStats() {
            const now = new Date();
            const startOfMonth = getLocalDateString(new Date(now.getFullYear(), now.getMonth(), 1));
            const endOfMonth = getLocalDateString(new Date(now.getFullYear(), now.getMonth() + 1, 0));
            const selectedDayString = getLocalDateString(currentSelectedFullDate);

            const slotsCollectionRef = collection(db, "classSlots");

            // Base query for all completed slots, filtered by teacher if not an admin
            let baseCompletedQuery = query(slotsCollectionRef, where("status", "==", "completed"));
            if (!currentUser.isAdmin) {
                baseCompletedQuery = query(baseCompletedQuery, where("teacherId", "==", currentUser.uid));
            }

            // Query for the selected day's count
            const dayCountQuery = query(baseCompletedQuery, where("date", "==", selectedDayString));

            // Query for the current month's count
            const monthCountQuery = query(baseCompletedQuery,
                where("date", ">=", startOfMonth),
                where("date", "<=", endOfMonth)
            );

            // Fetch counts in parallel
            const [daySnapshot, monthSnapshot] = await Promise.all([
                getCountFromServer(dayCountQuery),
                getCountFromServer(monthCountQuery)
            ]);

            statsSelectedDay.textContent = daySnapshot.data().count;
            statsCurrentMonth.textContent = monthSnapshot.data().count;

            // Add '(All Teachers)' note for admins
            const statLabels = document.querySelectorAll('#teacher-stats-container .stat-label');
            statLabels.forEach(label => {
                const existingAdminNote = label.querySelector('.stat-label-admin-note');
                if (existingAdminNote) existingAdminNote.remove();

                if (currentUser.isAdmin) {
                    const adminNote = document.createElement('span');
                    adminNote.className = 'stat-label-admin-note';
                    adminNote.textContent = '(All Teachers)';
                    label.appendChild(adminNote);
                }
            });
        }

        /**
         * Renders earnings stats by fetching only the necessary completed documents.
         * This is far more efficient than fetching the entire collection.
         */
        async function renderEarningsStats() {
            const now = new Date();
            const startOfMonth = getLocalDateString(new Date(now.getFullYear(), now.getMonth(), 1));
            const endOfMonth = getLocalDateString(new Date(now.getFullYear(), now.getMonth() + 1, 0));
            const selectedDayString = getLocalDateString(currentSelectedFullDate);

            const slotsCollectionRef = collection(db, "classSlots");

            let baseCompletedQuery = query(slotsCollectionRef, where("status", "==", "completed"));
            if (!currentUser.isAdmin) {
                baseCompletedQuery = query(baseCompletedQuery, where("teacherId", "==", currentUser.uid));
            }

            const dayEarningsQuery = query(baseCompletedQuery, where("date", "==", selectedDayString));
            const monthEarningsQuery = query(baseCompletedQuery,
                where("date", ">=", startOfMonth),
                where("date", "<=", endOfMonth)
            );

            const [dayDocsSnapshot, monthDocsSnapshot] = await Promise.all([
                getDocs(dayEarningsQuery),
                getDocs(monthEarningsQuery)
            ]);

            let todayEarnings = 0;
            dayDocsSnapshot.forEach(doc => {
                todayEarnings += doc.data().earnings || 0;
            });

            let monthlyEarnings = 0;
            monthDocsSnapshot.forEach(doc => {
                monthlyEarnings += doc.data().earnings || 0;
            });

            statsTodayEarnings.textContent = `${todayEarnings}`;
            statsMonthlyEarnings.textContent = `${monthlyEarnings}`;
        }

        // =================================================================
        // END: EFFICIENT DASHBOARD STATS LOGIC
        // =================================================================

        // =================================================================
        // START: NEW SALARY HIGHLIGHT AND HISTORY LOGIC
        // =================================================================

        /**
         * Calculates the total earnings for a specific user for the month PREVIOUS to the given date.
         * @param {string} userId - The UID of the teacher.
         * @param {Date} currentDate - The date to calculate the previous month from (usually today).
         * @returns {Promise<number>} - The total earnings for the previous month.
         */
        async function getPreviousMonthEarnings(userId, currentDate) {
            const lastMonthDate = new Date(currentDate);
            lastMonthDate.setDate(0); // Sets the date to the last day of the previous month

            const year = lastMonthDate.getFullYear();
            const month = lastMonthDate.getMonth();

            const startOfMonth = getLocalDateString(new Date(year, month, 1));
            const endOfMonth = getLocalDateString(new Date(year, month + 1, 0));

            const slotsCollectionRef = collection(db, "classSlots");
            const q = query(slotsCollectionRef,
                where("teacherId", "==", userId),
                where("status", "==", "completed"),
                where("date", ">=", startOfMonth),
                where("date", "<=", endOfMonth)
            );

            const querySnapshot = await getDocs(q);
            let totalEarnings = 0;
            querySnapshot.forEach(doc => {
                totalEarnings += doc.data().earnings || 0;
            });

            return totalEarnings;
        }

        /**
         * Checks if today is the 1st of the month and displays the salary highlight box if so.
         * This function is intended for non-admin users.
         */
        /**
            * Checks if the *selected* date is the 1st of the month and displays the salary highlight box if so.
            * This function is intended for non-admin users.
            * @param {Date} selectedDate - The date object for the day the user has clicked on.
            */
        async function checkAndDisplaySalaryMessageForSelectedDate(selectedDate) {
            // Hide the box immediately if the user is an admin or not logged in.
            if (!currentUser || currentUser.isAdmin) {
                salaryHighlightBox.classList.add('hidden');
                return;
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            // The key change: Check if the *selected* date's day is '1'.
            if (selectedDate.getDate() === 1 && selectedDate <= today) {
                try {
                    // This function correctly gets earnings for the month *before* the selectedDate.
                    const earnings = await getPreviousMonthEarnings(currentUser.uid, selectedDate);

                    if (earnings > 0) {
                        // Dynamically generate the title for the correct month and year.
                        const prevMonthDate = new Date(selectedDate);
                        prevMonthDate.setDate(0); // This clever trick sets the date to the last day of the previous month.
                        const monthName = prevMonthDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });

                        // Update the text in the salary box to be dynamic.
                        document.getElementById('salary-highlight-title').textContent = `Salary Release for ${monthName}`;
                        document.getElementById('salary-highlight-details').innerHTML = `Total earnings for ${monthName}: <span id="salary-highlight-amount">${earnings}</span>`;
                        document.getElementById('salary-highlight-amount').textContent = `${earnings}`;

                        // Finally, show the box.
                        salaryHighlightBox.classList.remove('hidden');
                    } else {
                        // If there were no earnings, keep the box hidden.
                        salaryHighlightBox.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching previous month's earnings for selected date:", error);
                    salaryHighlightBox.classList.add('hidden');
                }
            } else {
                // If the selected date is NOT the 1st, ensure the box is hidden.
                salaryHighlightBox.classList.add('hidden');
            }
        }
        /**
         * Fetches and renders the salary history for the last 12 months for the current teacher.
         */
        async function renderSalaryHistory() {
            if (!currentUser || currentUser.isAdmin) return;

            salaryHistoryModal.classList.add('active');
            salaryHistoryList.innerHTML = '';
            salaryHistoryLoader.classList.remove('hidden');

            try {
                const monthsToDisplay = [];
                for (let i = 1; i <= 12; i++) {
                    const date = new Date();
                    date.setDate(1); // Go to the 1st of the current month
                    date.setMonth(date.getMonth() - i); // Go back i months
                    monthsToDisplay.push(new Date(date));
                }

                // This function runs a query for a given month
                const calculateEarningsForMonth = async (monthDate) => {
                    const year = monthDate.getFullYear();
                    const month = monthDate.getMonth();
                    const startOfMonth = getLocalDateString(new Date(year, month, 1));
                    const endOfMonth = getLocalDateString(new Date(year, month + 1, 0));

                    const q = query(collection(db, "classSlots"),
                        where("teacherId", "==", currentUser.uid),
                        where("status", "==", "completed"),
                        where("date", ">=", startOfMonth),
                        where("date", "<=", endOfMonth)
                    );

                    const querySnapshot = await getDocs(q);
                    let totalEarnings = 0;
                    querySnapshot.forEach(doc => {
                        totalEarnings += doc.data().earnings || 0;
                    });
                    return {
                        date: monthDate,
                        earnings: totalEarnings
                    };
                };

                const results = await Promise.all(monthsToDisplay.map(d => calculateEarningsForMonth(d)));

                salaryHistoryLoader.classList.add('hidden');

                results.forEach(result => {
                    if (result.earnings > 0) { // Only show months where there were earnings
                        const item = document.createElement('div');
                        item.className = 'salary-history-item';
                        const monthName = result.date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                        item.innerHTML = `
                            <span class="salary-history-month">${monthName}</span>
                            <span class="salary-history-amount">${result.earnings}</span>
                        `;
                        salaryHistoryList.appendChild(item);
                    }
                });

                if (!salaryHistoryList.hasChildNodes()) {
                    salaryHistoryList.innerHTML = '<p class="text-muted">No earnings recorded in the past 12 months.</p>';
                }

            } catch (error) {
                console.error("Error rendering salary history:", error);
                salaryHistoryLoader.classList.add('hidden');
                salaryHistoryList.innerHTML = '<p style="color: var(--accent-red);">Could not load history.</p>';
            }
        }

        // Event listeners for the new modal and button
        viewSalaryHistoryButton.addEventListener('click', renderSalaryHistory);
        closeSalaryHistoryModalButton.addEventListener('click', () => salaryHistoryModal.classList.remove('active'));
        salaryHistoryModal.addEventListener('click', (e) => {
            if (e.target === salaryHistoryModal) {
                salaryHistoryModal.classList.remove('active');
            }
        });

        // =================================================================
        // END: NEW SALARY HIGHLIGHT AND HISTORY LOGIC
        // =================================================================

        function displayMotivationalQuote() {
            if (motivationalQuoteEl) {
                if (currentUser && currentUser.isAdmin) {
                    motivationalQuoteEl.textContent = "Admin Dashboard: Overseeing all schedules. Ensure smooth operations for all teachers!";
                    motivationalQuoteEl.style.color = "var(--accent-orange)";
                } else {
                    const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
                    motivationalQuoteEl.textContent = motivationalQuotes[randomIndex];
                    motivationalQuoteEl.style.color = "var(--accent-green)";
                }
            }
        }

        async function checkAndAutoCompleteSlots(dayString) {
            return;
        }

        async function checkForLongSessions() {
            if (!currentUser || !currentSelectedFullDate || longSessionMessageShownToday || currentUser.isAdmin) {
                return;
            }

            const dayString = getLocalDateString(currentSelectedFullDate);
            const slotsCollectionRef = collection(db, "classSlots");
            const q = query(slotsCollectionRef,
                where("date", "==", dayString),
                where("teacherId", "==", currentUser.uid),
                where("status", "!=", "cancelled"),
                orderBy("status"), // This is a trick to use a composite index
                orderBy("startTime")
            );

            const querySnapshot = await getDocs(q);
            const todaysSlots = querySnapshot.docs.map(doc => doc.data());

            if (todaysSlots.length < 4) {
                return;
            }

            let consecutiveCount = 1;
            for (let i = 1; i < todaysSlots.length; i++) {
                const prevSlotEndTime = timeToMinutes(todaysSlots[i - 1].endTime);
                const currentSlotStartTime = timeToMinutes(todaysSlots[i].startTime);

                if (currentSlotStartTime === prevSlotEndTime) {
                    consecutiveCount++;
                } else {
                    consecutiveCount = 1;
                }

                if (consecutiveCount >= 4) {
                    showNotification(`4 back-to-back classes detected! Please schedule a 30-min break to re-energize. Your health is a priority.`, "warning");
                    longSessionMessageShownToday = true;
                    return;
                }
            }
        }

        // =================================================================
        // START: NEW FUNCTION FOR TEACHER PERFORMANCE METRICS
        // =================================================================
        // =================================================================
        // START: NEW FUNCTION FOR CANCELLATION TRACKER
        // =================================================================
        async function updateTeacherPerformanceMetrics() {
            // This feature is only for individual teachers, not for the admin view.
            if (!currentUser || currentUser.isAdmin) {
                teacherCancellationMetric.classList.add('hidden');
                return;
            }

            teacherCancellationMetric.classList.remove('hidden');

            const now = new Date();
            const startOfMonth = getLocalDateString(new Date(now.getFullYear(), now.getMonth(), 1));
            const endOfMonth = getLocalDateString(new Date(now.getFullYear(), now.getMonth() + 1, 0));

            // Create a query to count all classes cancelled by the current teacher this month
            const monthlyCancelledQuery = query(collection(db, "classSlots"),
                where("teacherId", "==", currentUser.uid),
                where("date", ">=", startOfMonth),
                where("date", "<=", endOfMonth),
                where("status", "==", "cancelled")
            );

            try {
                const monthlyCancelledSnapshot = await getCountFromServer(monthlyCancelledQuery);
                const cancelledCount = monthlyCancelledSnapshot.data().count;

                // Update the big number in the UI
                cancellationCountEl.textContent = cancelledCount;

                // Change the color to red if there are any cancellations to make it more visible
                if (cancelledCount > 0) {
                    cancellationCountEl.style.color = 'var(--accent-red)';
                } else {
                    cancellationCountEl.style.color = 'var(--accent-green)'; // Show green for zero
                }
            } catch (error) {
                console.error("Error fetching cancellation count:", error);
                cancellationCountEl.textContent = 'Error';
            }
        }
        // =================================================================
        // END: NEW FUNCTION FOR CANCELLATION TRACKER
        // =================================================================

        // =================================================================
        // END: NEW FUNCTION FOR TEACHER PERFORMANCE METRICS
        // =================================================================


        // -----------------------------
        // AUTHENTICATION
        // -----------------------------
        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            if (!email || !password) {
                showNotification("Please enter email and password.", "error");
                return;
            }

            const originalButtonHTML = loginButton.innerHTML;
            loginButton.disabled = true;
            loginButton.innerHTML = `<span class="loader"></span>Please Wait...`;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showNotification(`Login failed: ${error.message}`, "error");
                loginButton.disabled = false;
                loginButton.innerHTML = originalButtonHTML;
            }
        });

        logoutButton.addEventListener('click', async () => {
            try { await signOut(auth); }
            catch (error) { showNotification(`Logout failed: ${error.message}`, "error"); }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                let isAdmin = false;
                let originalDisplayName = "";


                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    originalDisplayName = userData.displayName || user.email.split('@')[0];
                    if (userData.role === 'admin') {
                        isAdmin = true;
                        currentTeacherName = `${originalDisplayName} (Admin)`;
                        userDisplayName.classList.add('is-admin');
                    } else if (userData.role === 'student') {
                        // STUDENT LOGIN: Route to student dashboard
                        currentUser.isStudent = true;
                        currentUser.isAdmin = false;
                        currentUser.originalDisplayName = originalDisplayName;
                        currentUser.studentBatches = userData.batches || [];
                        authView.classList.add('hidden');
                        appView.classList.add('hidden');
                        document.getElementById('student-dashboard').classList.remove('hidden');
                        document.getElementById('student-display-name').textContent = originalDisplayName;
                        [loginEmailInput, loginPasswordInput].forEach(input => { if (input) input.value = ''; });
                        if (loginButton) { loginButton.disabled = false; loginButton.innerHTML = 'Login Securely'; }
                        showNotification(`Welcome, ${originalDisplayName}! Your dashboard is ready.`, 'success');
                        document.getElementById('student-logout-button').addEventListener('click', async () => {
                            try { await signOut(auth); } catch (e) { showNotification(`Logout failed: ${e.message}`, 'error'); }
                        });
                        initStudentDashboard();
                        return; // Exit early  skip teacher/admin flow
                    } else {
                        currentTeacherName = originalDisplayName;
                        userDisplayName.classList.remove('is-admin');
                    }
                } else {
                    originalDisplayName = user.email.split('@')[0];
                    currentTeacherName = originalDisplayName;
                    userDisplayName.classList.remove('is-admin');
                    try {
                        await setDoc(doc(db, "users", user.uid), {
                            displayName: originalDisplayName,
                            email: user.email,
                            role: "teacher"
                        });
                    } catch (docError) { console.error("Error creating missing user doc:", docError); }
                }
                currentUser.isAdmin = isAdmin;
                currentUser.originalDisplayName = originalDisplayName;

                listenForAnnouncements();

                const manageStudentsButton = document.getElementById('manage-students-button');
                if (isAdmin) {
                    manageAnnouncementsButton.classList.remove('hidden');
                    manageTeachersButton.classList.remove('hidden');
                    if (manageStudentsButton) manageStudentsButton.classList.remove('hidden');
                    notificationBell.classList.add('hidden');
                } else {
                    // Correctly hide the manage buttons for non-admins
                    manageAnnouncementsButton.classList.add('hidden');
                    manageTeachersButton.classList.add('hidden');
                    if (manageStudentsButton) manageStudentsButton.classList.add('hidden');
                    notificationBell.classList.remove('hidden');
                }


                userDisplayName.textContent = `Hi, ${currentTeacherName}!`;
                authView.classList.add('hidden');
                appView.classList.remove('hidden');
                updateDateDisplay();
                [loginEmailInput, loginPasswordInput].forEach(input => {
                    if (input) input.value = '';
                });

                allTeachersData = [];
                if (isAdmin) {
                    teacherOverviewButton.classList.remove('hidden'); // NEW: Show overview button for admin
                    console.log("Admin user logged in.");
                    showNotification(`Admin login successful: ${currentTeacherName}. Welcome!`, "success");
                    try {
                        const usersCollectionRef = collection(db, "users");
                        const qUsers = query(usersCollectionRef, orderBy("displayName"));
                        const usersSnapshot = await getDocs(qUsers);
                        usersSnapshot.forEach(doc => {
                            allTeachersData.push({ id: doc.id, ...doc.data() });
                        });
                        console.log("Fetched teachers for admin:", allTeachersData.length);
                    } catch (e) {
                        console.error("Error fetching teacher list for admin:", e);
                        showNotification("Could not load teacher list.", "error");
                    }
                } else {
                    teacherOverviewButton.classList.add('hidden'); // NEW: Hide overview button for non-admin
                    showNotification(`Login successful! Welcome, ${currentTeacherName}. Let's schedule.`, "success");
                }

                await checkAndDisplayPendingClassesWarning();
                const today = new Date();
                const dayOfWeek = today.getDay();
                currentWeekStartDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - dayOfWeek);
                currentWeekStartDate.setHours(0, 0, 0, 0);

                renderWeekSelector(currentWeekStartDate);
                await selectDay(today); // Make sure to await this on login
                // await checkAndDisplaySalaryMessage(); // <-- ADDED CALL FOR NEW FEATURE

            } else { // User is logged out
                currentUser = null; currentTeacherName = ""; allTeachersData = [];
                authView.classList.remove('hidden'); appView.classList.add('hidden');
                document.getElementById('student-dashboard').classList.add('hidden');
                dayScheduleView.classList.add('hidden');
                userDisplayName.classList.remove('is-admin');

                if (unsubscribeAnnouncementListener) {
                    unsubscribeAnnouncementListener();
                    unsubscribeAnnouncementListener = null;
                }
                manageAnnouncementsButton.classList.add('hidden');
                manageTeachersButton.classList.add('hidden');
                const manageStudentsBtn = document.getElementById('manage-students-button');
                if (manageStudentsBtn) manageStudentsBtn.classList.add('hidden');
                notificationBell.classList.add('hidden');
                notificationDot.classList.remove('visible');

                if (unsubscribeSlotsListener) { unsubscribeSlotsListener(); unsubscribeSlotsListener = null; }
                currentSelectedFullDate = null;
                currentWeekStartDate = null;
                weekSelector.innerHTML = '';

                if (motivationalQuoteEl) motivationalQuoteEl.textContent = '';
                if (statsSelectedDay) statsSelectedDay.textContent = '0';
                if (statsCurrentMonth) statsCurrentMonth.textContent = '0';
                if (statsTodayEarnings) statsTodayEarnings.textContent = '0';
                if (statsMonthlyEarnings) statsMonthlyEarnings.textContent = '0';
                const statLabels = document.querySelectorAll('#teacher-stats-container .stat-label .stat-label-admin-note');
                statLabels.forEach(note => note.remove());

                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.innerHTML = 'Login Securely';
                }

                teacherOverviewButton.classList.add('hidden');
                salaryHighlightBox.classList.add('hidden');
                // Clean up student dashboard state
                if (window._studentCalendar) { window._studentCalendar.destroy(); window._studentCalendar = null; }
                if (window._unsubStudentClasses) { window._unsubStudentClasses(); window._unsubStudentClasses = null; }
                if (window._unsubStudentAssignments) { window._unsubStudentAssignments(); window._unsubStudentAssignments = null; }
                if (auth.currentUser === null) {
                    showNotification("Logged out. See you soon!", "success");
                }
            }
        });







        // ADD ALL OF THESE NEW FUNCTIONS
        // This is the corrected function

        // =================================================================
        // START: NEW ANNOUNCEMENT MANAGEMENT LOGIC
        // =================================================================

        // --- Admin: Publish a new announcement ---
        async function publishNewAnnouncement() {
            const message = newAnnouncementTextarea.value.trim();
            if (!message) {
                showNotification("Announcement message cannot be empty.", "error");
                return;
            }
            publishNewAnnouncementButton.disabled = true;
            publishNewAnnouncementButton.textContent = 'Publishing...';
            try {
                // We now add a new document to the 'announcements' collection for each message
                await addDoc(collection(db, "announcements"), {
                    message: message,
                    author: currentUser.originalDisplayName || currentUser.email,
                    publishedAt: serverTimestamp(),
                    isDeleted: false // Flag for soft deletes
                });
                showNotification("Announcement published successfully!", "success");
                newAnnouncementTextarea.value = '';
            } catch (error) {
                console.error("Error publishing announcement:", error);
                showNotification("Failed to publish announcement.", "error");
            } finally {
                publishNewAnnouncementButton.disabled = false;
                publishNewAnnouncementButton.textContent = 'Publish New Announcement';
            }
        }

        // --- Admin: Edit an existing announcement ---
        async function editAnnouncement(id, currentMessage) {
            const newMessage = prompt("Edit the announcement message:", currentMessage);
            if (newMessage === null || newMessage.trim() === "") {
                showNotification("Edit cancelled.", "info");
                return;
            }
            try {
                const announcementRef = doc(db, "announcements", id);
                await updateDoc(announcementRef, { message: newMessage.trim() });
                showNotification("Announcement updated successfully.", "success");
            } catch (error) {
                console.error("Error updating announcement:", error);
                showNotification("Failed to update announcement.", "error");
            }
        }

        // --- Admin: Soft-delete an announcement ---
        async function deleteAnnouncement(id, isCurrentlyDeleted) {
            const action = isCurrentlyDeleted ? "restore" : "delete";
            const confirmation = confirm(`Are you sure you want to ${action} this announcement?`);
            if (!confirmation) return;

            try {
                const announcementRef = doc(db, "announcements", id);
                // We set a flag instead of permanently deleting the data
                await updateDoc(announcementRef, { isDeleted: !isCurrentlyDeleted });
                showNotification(`Announcement ${action}d successfully.`, "success");
            } catch (error) {
                console.error(`Error ${action}ing announcement:`, error);
                showNotification(`Failed to ${action} announcement.`, "error");
            }
        }

        // --- Renders the list of announcements for Admins (with controls) ---
        function renderAdminAnnouncementsList(announcements) {
            announcementsHistoryList.innerHTML = '';
            if (announcements.length === 0) {
                announcementsHistoryList.innerHTML = '<p>No announcements have been made yet.</p>';
                return;
            }
            announcements.forEach(ann => {
                const item = document.createElement('div');
                item.className = 'announcement-history-item';
                if (ann.isDeleted) {
                    item.classList.add('is-deleted');
                }

                const publishedDate = ann.publishedAt ? ann.publishedAt.toDate() : new Date();
                const formattedDate = publishedDate.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
                const deleteButtonText = ann.isDeleted ? 'Restore' : 'Delete';

                item.innerHTML = `
            <div class="announcement-content">${ann.message}</div>
            <div class="announcement-meta">
                <span>By: <strong>${ann.author}</strong> on ${formattedDate}</span>
                ${ann.isDeleted ? '<span style="color: var(--accent-red);">DELETED</span>' : ''}
            </div>
            <div class="admin-actions">
                <button class="btn btn-secondary edit-btn">Edit</button>
                <button class="btn btn-danger delete-btn">${deleteButtonText}</button>
            </div>
        `;
                item.querySelector('.edit-btn').addEventListener('click', () => editAnnouncement(ann.id, ann.message));
                item.querySelector('.delete-btn').addEventListener('click', () => deleteAnnouncement(ann.id, ann.isDeleted));
                announcementsHistoryList.appendChild(item);
            });
        }

        // --- Renders the list of announcements for Teachers (read-only) ---
        function renderTeacherAnnouncementsList(announcements) {
            teacherAnnouncementsList.innerHTML = '';
            if (announcements.length === 0) {
                teacherAnnouncementsList.innerHTML = '<p>No announcements are available at this time.</p>';
                return;
            }
            announcements.forEach(ann => {
                const item = document.createElement('div');
                item.className = 'announcement-history-item'; // Reuse the same style
                const publishedDate = ann.publishedAt ? ann.publishedAt.toDate() : new Date();
                const formattedDate = publishedDate.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });

                item.innerHTML = `
            <div class="announcement-content">${ann.message}</div>
            <div class="announcement-meta">
                <span>Published on ${formattedDate}</span>
            </div>
        `;
                teacherAnnouncementsList.appendChild(item);
            });
        }

        // --- Main listener for all announcement changes ---
        function listenForAnnouncements() {
            if (unsubscribeAnnouncementListener) unsubscribeAnnouncementListener();

            // Query the 'announcements' collection, ordering by newest first
            const q = query(collection(db, "announcements"), orderBy("publishedAt", "desc"));

            unsubscribeAnnouncementListener = onSnapshot(q, (snapshot) => {
                const allAnnouncements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (currentUser.isAdmin) {
                    // Admin sees all announcements, including deleted ones
                    renderAdminAnnouncementsList(allAnnouncements);
                } else {
                    // Teacher sees only non-deleted announcements
                    const activeAnnouncements = allAnnouncements.filter(ann => !ann.isDeleted);
                    renderTeacherAnnouncementsList(activeAnnouncements);

                    // Logic to show the notification dot
                    if (activeAnnouncements.length > 0) {
                        const latestTimestamp = activeAnnouncements[0].publishedAt.toMillis().toString();
                        const lastSeenTimestamp = localStorage.getItem('lastSeenAnnouncementTimestamp');
                        if (latestTimestamp !== lastSeenTimestamp) {
                            notificationDot.classList.add('visible');
                        } else {
                            notificationDot.classList.remove('visible');
                        }
                    } else {
                        notificationDot.classList.remove('visible');
                    }
                }
            });
        }

        // --- Event Listeners for new modals and buttons ---
        manageAnnouncementsButton.addEventListener('click', () => {
            adminManagerModal.classList.add('active');
        });
        closeAdminManagerModalButton.addEventListener('click', () => {
            adminManagerModal.classList.remove('active');
        });
        publishNewAnnouncementButton.addEventListener('click', publishNewAnnouncement);

        notificationBell.addEventListener('click', () => {
            announcementModal.classList.add('active');
            // Mark the latest announcement as seen
            const q = query(collection(db, "announcements"), orderBy("publishedAt", "desc"), limit(1));
            getDocs(q).then(snapshot => {
                if (!snapshot.empty) {
                    const latestAnn = snapshot.docs[0].data();
                    if (latestAnn.publishedAt) {
                        localStorage.setItem('lastSeenAnnouncementTimestamp', latestAnn.publishedAt.toMillis().toString());
                    }
                }
                notificationDot.classList.remove('visible');
            });
        });

        closeAnnouncementModalButton.addEventListener('click', () => {
            announcementModal.classList.remove('active');
        });
        // =================================================================
        // END: NEW ANNOUNCEMENT MANAGEMENT LOGIC
        // =================================================================



        // -----------------------------
        // WEEK AND DAY VIEW MANAGEMENT
        // -----------------------------

        function renderWeekSelector(startDate) {
            weekSelector.innerHTML = '';
            let currentDayIterator = new Date(startDate);

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentDayIterator);
                dayDate.setDate(currentDayIterator.getDate() + i);

                const dayButton = document.createElement('button');
                const dayName = daysOfWeekDisplay[dayDate.getDay()];
                const dateOfMonth = dayDate.getDate();
                const monthShort = dayDate.toLocaleDateString('en-US', { month: 'short' });

                dayButton.innerHTML = `${dayName} <span class="date-small">${dateOfMonth} ${monthShort}</span>`;
                dayButton.classList.add('btn');
                dayButton.dataset.fullDate = getLocalDateString(dayDate);

                dayButton.addEventListener('click', () => selectDay(new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate())));
                weekSelector.appendChild(dayButton);
            }
        }

        async function selectDay(dateObject) {
            currentSelectedFullDate = dateObject;
            const dayString = getLocalDateString(dateObject);

            const dayName = daysOfWeekDisplay[dateObject.getDay()];
            const dateOfMonth = dateObject.getDate();
            const monthLong = dateObject.toLocaleDateString('en-US', { month: 'long' });

            dayTitle.textContent = `All Classes for: ${dayName}, ${monthLong} ${dateOfMonth}`;
            dayScheduleView.classList.remove('hidden');

            document.querySelectorAll('#week-selector button').forEach(btn => {
                btn.classList.remove('active-day');
                if (btn.dataset.fullDate === dayString) {
                    btn.classList.add('active-day');
                }
            });

            longSessionMessageShownToday = false;
            displayMotivationalQuote();

            // Run schedule fetching and stats updates in parallel.
            await Promise.all([
                fetchAndDisplaySlots(dayString),
                updateAllDashboardStats(),
                checkAndDisplaySalaryMessageForSelectedDate(dateObject),
                updateTeacherPerformanceMetrics()

            ]);

            checkForLongSessions();
        }

        prevWeekButton.addEventListener('click', () => {
            if (!currentWeekStartDate) return;
            currentWeekStartDate.setDate(currentWeekStartDate.getDate() - 7);
            renderWeekSelector(currentWeekStartDate);
            selectDay(new Date(currentWeekStartDate));
        });

        nextWeekButton.addEventListener('click', () => {
            if (!currentWeekStartDate) return;
            currentWeekStartDate.setDate(currentWeekStartDate.getDate() + 7);
            renderWeekSelector(currentWeekStartDate);
            selectDay(new Date(currentWeekStartDate));
        });


        // -----------------------------
        // CLASS SLOT MANAGEMENT
        // -----------------------------

        // START: NEW FUNCTION for the license timeline

        // START: NEW FUNCTION for the license timeline
        function renderLicenseTimeline(slots) {
            const timelineContainer = document.getElementById('license-timeline-container');
            if (!timelineContainer) return;
            timelineContainer.innerHTML = ''; // Clear previous state

            // --- Configuration to match your timeline's axis ---
            const TIMELINE_START_HOUR = 6; // The timeline visually starts at 6 AM
            const TIMELINE_DURATION_HOURS = 20; // It spans 20 hours (from 6 AM to 2 AM the next day)

            const TIMELINE_START_MINUTES = TIMELINE_START_HOUR * 60; // 360
            const TIMELINE_TOTAL_MINUTES = TIMELINE_DURATION_HOURS * 60; // 1200
            const MINUTES_IN_DAY = 24 * 60; // 1440

            const slotsByLicense = {};
            slots.forEach(slot => {
                if (!slot.licenseId) return; // Skip slots without a license
                if (!slotsByLicense[slot.licenseId]) {
                    slotsByLicense[slot.licenseId] = [];
                }
                slotsByLicense[slot.licenseId].push(slot);
            });

            for (let i = 1; i <= TOTAL_LICENSES; i++) {
                const licenseRow = document.createElement('div');
                licenseRow.className = 'license-row';

                const licenseLabel = document.createElement('div');
                licenseLabel.className = 'license-label';
                licenseLabel.textContent = `License ${i}`;

                const timelineBar = document.createElement('div');
                timelineBar.className = 'timeline-bar';

                const licenseSlots = slotsByLicense[i] || [];
                licenseSlots.forEach(slot => {
                    let startTimeInMinutes = timeToMinutes(slot.startTime);
                    let endTimeInMinutes = timeToMinutes(slot.endTime);

                    // This handles overnight classes (e.g., a class from 23:00 to 01:00)
                    if (endTimeInMinutes <= startTimeInMinutes) {
                        endTimeInMinutes += MINUTES_IN_DAY;
                    }

                    // This handles classes in the early morning (e.g., 1 AM to 2 AM)
                    // by correctly placing them at the end of the timeline view.
                    if (startTimeInMinutes < TIMELINE_START_MINUTES) {
                        startTimeInMinutes += MINUTES_IN_DAY;
                        endTimeInMinutes += MINUTES_IN_DAY;
                    }

                    // Now, calculate the block's position relative to the timeline's start and duration
                    const offsetMinutes = startTimeInMinutes - TIMELINE_START_MINUTES;
                    const durationMinutes = endTimeInMinutes - startTimeInMinutes;

                    // We only need to render slots that are actually visible on the timeline axis
                    if (durationMinutes > 0 && offsetMinutes < TIMELINE_TOTAL_MINUTES && (offsetMinutes + durationMinutes) > 0) {
                        const leftPercentage = (offsetMinutes / TIMELINE_TOTAL_MINUTES) * 100;
                        const widthPercentage = (durationMinutes / TIMELINE_TOTAL_MINUTES) * 100;

                        const timelineSlot = document.createElement('div');
                        timelineSlot.className = 'timeline-slot';
                        // Set the calculated position and width
                        timelineSlot.style.left = `${leftPercentage}%`;
                        timelineSlot.style.width = `${widthPercentage}%`;

                        if (slot.teacherId === currentUser.uid) {
                            timelineSlot.classList.add('is-own');
                        }
                        if (slot.status === 'cancelled') {
                            timelineSlot.classList.add('is-cancelled');
                        }

                        const tooltipText = `Topic: ${slot.topic}\nTeacher: ${slot.teacherName}\nTime: ${slot.startTime} - ${slot.endTime}${slot.status === 'cancelled' ? '\nStatus: CANCELLED' : ''}`;
                        timelineSlot.setAttribute('data-tooltip', tooltipText);

                        timelineBar.appendChild(timelineSlot);
                    }
                });

                licenseRow.appendChild(licenseLabel);
                licenseRow.appendChild(timelineBar);
                timelineContainer.appendChild(licenseRow);
            }
        }
        // END: NEW FUNCTION

        // START: MODIFIED FUNCTION to call the timeline renderer
        async function fetchAndDisplaySlots(dayString) {
            if (!currentUser) return;
            if (unsubscribeSlotsListener) unsubscribeSlotsListener();

            const slotsCollection = collection(db, "classSlots");

            const q = query(slotsCollection,
                where("date", "==", dayString),
                orderBy("startTime")
            );

            unsubscribeSlotsListener = onSnapshot(q, (querySnapshot) => {
                slotsList.innerHTML = '';
                dayScheduleView.classList.remove('hidden');

                const allSlots = [];
                querySnapshot.forEach((docSnap) => {
                    allSlots.push({ id: docSnap.id, ...docSnap.data() });
                });

                // Render the new timeline view with all slots for the day
                renderLicenseTimeline(allSlots);

                // Continue with existing logic to render class cards
                let mySlots = [];
                let otherSlots = [];
                allSlots.forEach(slotData => {
                    if (slotData.teacherId === currentUser.uid) {
                        mySlots.push(slotData);
                    } else {
                        otherSlots.push(slotData);
                    }
                });


                if (mySlots.length > 0) {
                    const myClassesHeader = document.createElement('h3');
                    myClassesHeader.textContent = "My Classes";
                    myClassesHeader.style.color = 'var(--accent-main)';
                    myClassesHeader.style.marginTop = '1rem';
                    slotsList.appendChild(myClassesHeader);

                    const mySlotsUl = document.createElement('ul');
                    mySlotsUl.classList.add('slots-grid');
                    mySlots.forEach(slotData => {
                        const slotElement = createSlotElement(slotData.id, slotData);
                        mySlotsUl.appendChild(slotElement);
                    });
                    slotsList.appendChild(mySlotsUl);
                }

                if (otherSlots.length > 0) {
                    if (mySlots.length > 0) {
                        const separator = document.createElement('hr');
                        separator.style.borderColor = 'var(--border-color)';
                        separator.style.marginTop = '2rem';
                        separator.style.marginBottom = '2rem';
                        slotsList.appendChild(separator);
                    }

                    const otherClassesHeader = document.createElement('h3');
                    otherClassesHeader.textContent = "Other Teachers' Classes";
                    otherClassesHeader.style.color = 'var(--accent-orange)';
                    otherClassesHeader.style.marginTop = '1rem';
                    slotsList.appendChild(otherClassesHeader);

                    const otherSlotsUl = document.createElement('ul');
                    otherSlotsUl.classList.add('slots-grid');
                    otherSlots.forEach(slotData => {
                        const slotElement = createSlotElement(slotData.id, slotData);
                        otherSlotsUl.appendChild(slotElement);
                    });
                    slotsList.appendChild(otherSlotsUl);
                }

                if (mySlots.length === 0 && otherSlots.length === 0) {
                    noSlotsMessage.classList.remove('hidden');
                } else {
                    noSlotsMessage.classList.add('hidden');
                }

                if (!currentUser.isAdmin) checkForLongSessions();

            }, (error) => {
                console.error("Error fetching slots:", error);
                showNotification("Error fetching class slots.", "error");
            });
        }
        // END: MODIFIED FUNCTION

        function createSlotElement(id, slotData) {
            const listItem = document.createElement('li');
            listItem.classList.add('slot-item');
            listItem.dataset.id = id;

            if (slotData.teacherId === currentUser.uid) {
                listItem.classList.add('is-own');
            } else {
                listItem.classList.add('is-other-teacher');
            }

            let statusHTML = '';
            // Check for the timestamp and format it for display
            const statusTimestamp = slotData.statusChangedAt ? ` at ${formatTimestampForDisplay(slotData.statusChangedAt)}` : '';

            if (slotData.status === 'cancelled') {
                listItem.classList.add('is-cancelled');
                // Add the formatted timestamp to the HTML string
                statusHTML = `<div class="status-cancelled">Status: <strong>CANCELLED</strong>${statusTimestamp}<br>Reason: ${slotData.cancellationReason || 'Not specified'}</div>`;
            } else if (slotData.status === 'completed') {
                listItem.classList.add('is-completed');
                // Add the formatted timestamp to the HTML string
                statusHTML = `<div class="status-completed">Status: <strong>COMPLETED</strong>${statusTimestamp}</div>`;
            }

            const detailsDiv = document.createElement('div');
            detailsDiv.classList.add('slot-details');

            let teacherNameDisplay = slotData.teacherName || 'N/A';
            if (currentUser.isAdmin && slotData.teacherId !== currentUser.uid) {
                teacherNameDisplay = `<span class="admin-view-teacher-highlight">${teacherNameDisplay}</span>`;
            }
            // =================================================================
            // START: MODIFIED LICENSE DISPLAY LOGIC
            // =================================================================
            let licenseDisplay = '';
            if (slotData.licenseId > 0) {
                // This is a standard, numbered license.
                licenseDisplay = `<span class="license-info">Zoom License: ${slotData.licenseId}</span>`;
            } else if (slotData.hasOwnProperty('licenseId') && slotData.licenseId === 0) {
                // This is the special case for a personal license.
                licenseDisplay = `<span class="license-info">Please use personal zoom and upload recording in the website as all zoom licenses are occupied</span>`;
            }
            // If licenseId is null, undefined, or something else, it will display nothing.
            // =================================================================
            // END: MODIFIED LICENSE DISPLAY LOGIC
            // =================================================================

            let tagDisplay = '';
            if (slotData.tag && slotData.tag !== 'none') {
                const tagText = slotData.tag === 'group' ? 'Group Class' : 'Personalized';
                tagDisplay = `<span class="slot-tag">${tagText}</span>`;
            }

            const displayStartTime = calculateDisplayStartTime(slotData.startTime);
            const displayEndTime = calculateDisplayEndTime(slotData.startTime, slotData.endTime);
            const originalTimeText = `(Scheduled: ${slotData.startTime} - ${slotData.endTime})`;

            let timestampHTML = '';
            // Only show timestamps for the owner or an admin
            if (currentUser && (currentUser.isAdmin || slotData.teacherId === currentUser.uid)) {
                const created = slotData.createdAt ? `Created: ${formatTimestampForDisplay(slotData.createdAt)}` : '';
                // Only show 'Edited' if it's different from creation time.
                const updated = slotData.updatedAt && slotData.updatedAt !== slotData.createdAt
                    ? `  Edited: ${formatTimestampForDisplay(slotData.updatedAt)}`
                    : '';

                if (created || updated) {
                    timestampHTML = `<div class="slot-timestamp-info">${created}${updated}</div>`;
                }
            }

            detailsDiv.innerHTML = `
                <div class="topic">${slotData.topic}</div>
                <strong>${displayStartTime} - ${displayEndTime} ${tagDisplay}</strong><br>
                <span class="teacher">Teacher: ${teacherNameDisplay} ${originalTimeText}</span>${licenseDisplay}
                ${statusHTML}
                ${timestampHTML}
            `;

            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('slot-actions');

            const now = new Date();
            const slotDateParts = slotData.date.split('-');
            const [endHours, endMinutes] = slotData.endTime.split(':').map(Number);
            const slotEndTimeObject = new Date(parseInt(slotDateParts[0]), parseInt(slotDateParts[1]) - 1, parseInt(slotDateParts[2]), endHours, endMinutes);

            const isOwner = slotData.teacherId === currentUser.uid;
            const isAdmin = currentUser && currentUser.isAdmin;
            const canControl = isOwner || isAdmin;
            const isFuture = now <= slotEndTimeObject;

            if (canControl) {
                // --- 1. EDIT Button ---
                if (isAdmin || (isOwner && slotData.status === 'scheduled' && isFuture)) {
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('btn', 'btn-secondary');
                    editButton.addEventListener('click', () => openSlotModal(id, slotData));
                    actionsDiv.appendChild(editButton);
                }

                // --- 2. Main Status Action Buttons ---
                if (slotData.status === 'scheduled') {
                    if (isFuture || isAdmin) {
                        const completedButton = document.createElement('button');
                        completedButton.textContent = 'Mark Completed';
                        completedButton.classList.add('btn', 'btn-success');
                        const canMarkComplete = now > slotEndTimeObject;
                        completedButton.disabled = !canMarkComplete;
                        if (!canMarkComplete) {
                            completedButton.title = `This button will be active after the class ends at ${slotData.endTime}.`;
                        }
                        completedButton.addEventListener('click', () => markAsCompleted(id, slotData));
                        actionsDiv.appendChild(completedButton);

                        const cancelButton = document.createElement('button');
                        cancelButton.textContent = 'Cancel Class';
                        cancelButton.classList.add('btn', 'btn-warning');
                        cancelButton.addEventListener('click', () => cancelSlot(id));
                        actionsDiv.appendChild(cancelButton);
                    }
                    else if (isOwner && !isFuture && !isAdmin) {
                        const completedButton = document.createElement('button');
                        completedButton.textContent = 'Completed';
                        completedButton.classList.add('btn', 'btn-success');
                        completedButton.addEventListener('click', () => markAsCompleted(id, slotData));
                        actionsDiv.appendChild(completedButton);

                        const pastDueCancelButton = document.createElement('button');
                        pastDueCancelButton.textContent = 'Canceled';
                        pastDueCancelButton.classList.add('btn', 'btn-warning');
                        pastDueCancelButton.addEventListener('click', () => cancelSlot(id));
                        actionsDiv.appendChild(pastDueCancelButton);
                    }
                } else if (slotData.status === 'completed') {
                    const revertCompletionButton = document.createElement('button');
                    revertCompletionButton.textContent = 'Mark as Incomplete';
                    revertCompletionButton.classList.add('btn', 'btn-outline-primary');
                    revertCompletionButton.addEventListener('click', () => revertCompletion(id));
                    actionsDiv.appendChild(revertCompletionButton);

                } else if (slotData.status === 'cancelled') {
                    const reinstateButton = document.createElement('button');
                    reinstateButton.textContent = 'Reinstate Class';
                    reinstateButton.classList.add('btn', 'btn-outline-primary');
                    reinstateButton.addEventListener('click', () => reinstateClass(id));
                    actionsDiv.appendChild(reinstateButton);
                }

                // --- 3. DELETE Button (always available for admin/owner) ---
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.classList.add('btn', 'btn-danger');
                deleteButton.addEventListener('click', () => deleteSlot(id));
                actionsDiv.appendChild(deleteButton);
            }

            listItem.appendChild(detailsDiv);
            if (actionsDiv.hasChildNodes()) listItem.appendChild(actionsDiv);

            return listItem;
        }

        addSlotButton.addEventListener('click', () => openSlotModal());
        closeModalButton.addEventListener('click', () => slotModal.classList.remove('active'));

        function openSlotModal(id = null, existingData = null) {
            slotModal.classList.add('active');
            slotIdInput.value = id || '';
            initializeTimePickers();

            applyTagToFutureContainer.classList.add('hidden');
            applyTagToFutureCheckbox.checked = false;
            teacherSelectContainerAdmin.classList.add('hidden');

            modalTagContainer.classList.remove('hidden');


            modalTeacherSelect.innerHTML = '';
            if (currentUser && currentUser.isAdmin) {
                teacherSelectContainerAdmin.classList.remove('hidden');
                if (allTeachersData.length === 0) {
                    modalTeacherSelect.innerHTML = '<option value="">Loading teachers...</option>';
                }
                allTeachersData.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.displayName || teacher.email;
                    modalTeacherSelect.appendChild(option);
                });
                if (existingData && existingData.teacherId) {
                    modalTeacherSelect.value = existingData.teacherId;
                } else if (!existingData && currentUser.uid) {
                    const adminSelf = allTeachersData.find(t => t.id === currentUser.uid);
                    if (adminSelf) modalTeacherSelect.value = currentUser.uid;
                    else if (allTeachersData.length > 0) modalTeacherSelect.value = allTeachersData[0].id;
                }
            }

            if (existingData) { // Editing an existing slot
                modalTitle.textContent = 'Edit Class Slot';
                if (startTimePicker) startTimePicker.setDate(existingData.startTime, true);
                topicInput.value = existingData.topic;
                modalTagSelect.value = existingData.tag || 'none';

                if (currentUser && currentUser.isAdmin && existingData.recurringId) {
                    applyTagToFutureContainer.classList.remove('hidden');
                }

                const startMinutes = timeToMinutes(existingData.startTime);
                const endMinutes = timeToMinutes(existingData.endTime);
                if (existingData.startTime && existingData.endTime && endMinutes > startMinutes) {
                    const durationValue = endMinutes - startMinutes;
                    const optionExists = Array.from(durationSelect.options).some(opt => opt.value == durationValue.toString());
                    durationSelect.value = optionExists ? durationValue.toString() : "60";
                    if (!optionExists) showNotification("Original duration not standard, defaulted to 1 hour.", "warning");
                } else {
                    durationSelect.value = "60";
                }
                recurringContainer.classList.add('hidden');
                saveSlotButton.textContent = 'Update Slot';
                saveSlotButton.className = 'btn btn-primary';
            } else { // New slot
                modalTitle.textContent = 'Add New Class Slot';
                if (startTimePicker) {
                    const now = new Date();
                    const nextQuarterHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), Math.ceil(now.getMinutes() / 15) * 15);
                    startTimePicker.setDate(nextQuarterHour, true);
                }
                durationSelect.value = "60";
                topicInput.value = '';
                modalTagSelect.value = 'personalized';
                recurringCheckbox.checked = true;
                recurringContainer.classList.remove('hidden');
                saveSlotButton.textContent = 'Save Slot';
                saveSlotButton.className = 'btn btn-success';
            }
        }

        /* 
   SAVE    ADD / EDIT CLASS SLOT
    */
        saveSlotButton.addEventListener('click', async () => {

            //  0. BASIC VALIDATION 
            const id = slotIdInput.value;                // empty = new slot
            const startTime = startTimeInput.value;
            const selectedDurationMinutes = parseInt(durationSelect.value, 10);
            const topic = topicInput.value.trim();

            if (!currentUser || !currentSelectedFullDate) {
                showNotification("User not logged in or day not selected.", "error");
                return;
            }
            if (!startTime || isNaN(selectedDurationMinutes) || selectedDurationMinutes <= 0 || !topic) {
                showNotification("Start time, duration, and topic are required.", "warning");
                return;
            }

            // Disable button & show spinner
            saveSlotButton.disabled = true;
            const originalButtonHTML = saveSlotButton.innerHTML;
            saveSlotButton.innerHTML = `<span class="loader"></span>Saving`;

            try {

                //  1. RESOLVE TEACHER INFO 
                let teacherIdToSave, teacherNameToSave;
                if (currentUser.isAdmin) {
                    if (!modalTeacherSelect.value) throw new Error("Admin must select a teacher for the slot.");
                    teacherIdToSave = modalTeacherSelect.value;
                    const tch = allTeachersData.find(t => t.id === teacherIdToSave);
                    teacherNameToSave = tch ? (tch.displayName || tch.email) : "Unknown Teacher";
                } else {
                    teacherIdToSave = currentUser.uid;
                    teacherNameToSave = currentUser.originalDisplayName;
                }

                //  2. CLASS-TYPE & EARNINGS 
                const tagToSave = modalTagSelect.value;
                if (tagToSave === 'none')
                    throw new Error("Selecting a Class Type (Group or Personalized) is compulsory.");

                const earningsToSave =
                    tagToSave === 'group' ? GROUP_CLASS_EARNING
                        : tagToSave === 'personalized' ? PERSONALIZED_CLASS_EARNING
                            : 0;

                //  3. TIME CALCULATIONS 
                const endTime = calculateEndTime(startTime, selectedDurationMinutes);   // helper already in your code
                if (!endTime) throw new Error("Could not calculate end time.");
                // if (timeToMinutes(startTime) >= timeToMinutes(endTime))
                //     throw new Error("End time must be after start time.");

                const dayString = getLocalDateString(currentSelectedFullDate);
                const slotsCollection = collection(db, "classSlots");

                //  4. FETCH ALL SCHEDULED SLOTS FOR THAT DATE 
                const q = query(slotsCollection,
                    where("date", "==", dayString),
                    where("status", "==", "scheduled"));          // only active classes
                const snapshot = await getDocs(q);

                const newStartMinutes = timeToMinutes(startTime);
                const newEndMinutes = timeToMinutes(endTime);

                //  5. OVERLAP / LICENSE SAFETY NET (***FIXED***) 
                let personalOverlapFound = false;
                const usedLicenseIds = new Set();

                // ... inside the saveSlotButton listener ...

                for (const docSnap of snapshot.docs) {
                    const slot = { id: docSnap.id, ...docSnap.data() };
                    if (id && slot.id === id) continue; // ignore the slot being edited

                    const existingStartMinutes = timeToMinutes(slot.startTime);
                    const existingEndMinutes = timeToMinutes(slot.endTime);

                    /* 5-A Check for PERSONAL overlap (for the same teacher) */
                    if (slot.teacherId === teacherIdToSave) {
                        // Use the EXACT times for personal scheduling.
                        // An overlap occurs if the new class starts before the existing one ends,
                        // AND the new class ends after the existing one has started.
                        const personalOverlap =
                            newStartMinutes < existingEndMinutes &&
                            newEndMinutes > existingStartMinutes;

                        if (personalOverlap) {
                            personalOverlapFound = true;
                            break; // Found a personal clash, no need to check further.
                        }
                    }

                    /* 5-B Check for LICENSE overlap (with any other teacher) */
                    // Use the BUFFERED times to ensure licenses have breathing room.
                    const newStartBuffered = newStartMinutes - BUFFER_BEFORE_MIN;
                    const newEndBuffered = newEndMinutes + BUFFER_AFTER_MIN;

                    const existingStartBuffered = existingStartMinutes - BUFFER_BEFORE_MIN;
                    const existingEndBuffered = existingEndMinutes + BUFFER_AFTER_MIN;

                    const licenseOverlap =
                        newStartBuffered < existingEndBuffered &&
                        newEndBuffered > existingStartBuffered;

                    if (licenseOverlap && slot.licenseId) {
                        usedLicenseIds.add(slot.licenseId);
                    }
                }


                if (personalOverlapFound)
                    throw new Error(`This time slot overlaps with an existing class for ${teacherNameToSave}.`);

                //  6. ASSIGN LICENSE (ZOOM API + FIRESTORE HYBRID) 
                // Use the new hybrid approach that checks both Firestore schedules AND live Zoom status
                const licenseResult = await findAvailableLicenseHybrid(usedLicenseIds);
                const assignedLicenseId = licenseResult.licenseId;

                // Log the license assignment method for debugging
                console.log('License assignment result:', licenseResult);

                if (assignedLicenseId === 0) {
                    // No license available - show appropriate message based on reason
                    if (licenseResult.source === 'zoom_all_busy') {
                        showNotification("All Zoom licenses are currently in active meetings. This class will use a personal Zoom link.", "warning");
                    } else if (licenseResult.source === 'firestore') {
                        showNotification("All official licenses are scheduled. This class will use a personal Zoom link.", "warning");
                    } else {
                        showNotification("No license available. This class will use a personal Zoom link.", "warning");
                    }
                } else if (licenseResult.source === 'firestore_fallback' || licenseResult.source === 'firestore_error_fallback') {
                    // License assigned but Zoom API was unavailable
                    showNotification(`License ${assignedLicenseId} assigned (Zoom API unavailable - using schedule-based assignment).`, "info");
                }

                //  7. DATA TO SAVE 
                const dataToSave = {
                    date: dayString,
                    day: daysOfWeekDisplay[currentSelectedFullDate.getDay()].toLowerCase(),
                    startTime,
                    endTime,
                    topic,
                    teacherId: teacherIdToSave,
                    teacherName: teacherNameToSave,
                    licenseId: assignedLicenseId,
                    tag: tagToSave,
                    earnings: earningsToSave,
                };

                //  8. UPDATE  vs  CREATE 
                if (id) {  // EDIT EXISTING SLOT
                    const slotDocRef = doc(db, "classSlots", id);
                    const existingSnap = await getDoc(slotDocRef);
                    if (!existingSnap.exists()) throw new Error("The class slot you are trying to edit does not exist.");

                    // extra permission check for non-admin edits
                    if (!currentUser.isAdmin && existingSnap.data().teacherId !== currentUser.uid)
                        throw new Error("Permission denied to update this slot.");

                    /* ADMIN: propagate tag/earnings to future recurring classes if asked */
                    const applyToFuture = currentUser.isAdmin && applyTagToFutureCheckbox.checked;
                    if (applyToFuture && existingSnap.data().recurringId) {
                        const batch = writeBatch(db);
                        const recurringId = existingSnap.data().recurringId;
                        const fromDate = existingSnap.data().date;

                        const seriesQ = query(collection(db, "classSlots"),
                            where("recurringId", "==", recurringId),
                            where("date", ">=", fromDate));
                        const seriesSnap = await getDocs(seriesQ);

                        seriesSnap.forEach(d =>
                            batch.update(d.ref, { tag: tagToSave, earnings: earningsToSave })
                        );
                        await batch.commit();
                    }

                    // Add the updated timestamp before saving
                    dataToSave.updatedAt = new Date().toISOString();

                    await updateDoc(slotDocRef, dataToSave);                    // single-slot update
                    showNotification("Slot updated successfully!", "success");

                } else {  // CREATE NEW SLOT  (single or recurring)
                    const isRecurring = recurringCheckbox.checked;

                    // Add creation and update timestamps for new slots
                    const creationTime = new Date().toISOString();
                    dataToSave.createdAt = creationTime;
                    dataToSave.updatedAt = creationTime;


                    if (isRecurring) {
                        const batch = writeBatch(db);
                        const recurringId = doc(collection(db, 'classSlots')).id;   // unique id
                        for (let i = 0; i < 52; i++) {                              // one year
                            const slotDate = new Date(currentSelectedFullDate);
                            slotDate.setDate(slotDate.getDate() + i * 7);
                            const ref = doc(collection(db, "classSlots"));
                            batch.set(ref, {
                                ...dataToSave,
                                date: getLocalDateString(slotDate),
                                day: daysOfWeekDisplay[slotDate.getDay()].toLowerCase(),
                                recurringId,
                                status: 'scheduled'
                            });
                        }
                        await batch.commit();
                        showNotification("Recurring class created for the next year!", "success");

                    } else {   // single slot
                        await addDoc(collection(db, "classSlots"), {
                            ...dataToSave,
                            status: 'scheduled'
                        });
                        showNotification("Slot added successfully!", "success");
                    }
                }

                //  9. HOUSEKEEPING 
                slotModal.classList.remove('active');
                await updateAllDashboardStats();                                // refresh dashboard

            } catch (err) {
                const type = /overlap|Zoom licenses|compulsory/i.test(err.message) ? "warning" : "error";
                showNotification(err.message, type);
            } finally {
                saveSlotButton.disabled = false;
                saveSlotButton.innerHTML = originalButtonHTML;
            }
        });
        /*  */

        async function markAsCompleted(id, slotData) {
            let earnings = 0;
            if (slotData.tag === 'group') {
                earnings = GROUP_CLASS_EARNING;
            } else if (slotData.tag === 'personalized') {
                earnings = PERSONALIZED_CLASS_EARNING;
            }

            try {
                await updateDoc(doc(db, "classSlots", id), {
                    status: 'completed',
                    earnings: earnings,
                    manualCompleted: true,
                    statusChangedAt: new Date().toISOString()
                });
                showNotification("Class marked as Completed!", "success");
                await updateAllDashboardStats(); // Update stats after action
            } catch (err) {
                console.error("Error marking as completed:", err);
                showNotification(`Error: ${err.message}`, "error");
            }
        }

        async function revertCompletion(id) {
            const slotDocRef = doc(db, "classSlots", id);
            if (!confirm("Are you sure you want to mark this class as incomplete? Its earnings will be removed.")) {
                return;
            }
            try {
                await updateDoc(slotDocRef, {
                    status: 'scheduled',
                    earnings: 0,
                    manualCompleted: false,
                    cancellationReason: '',
                    statusChangedAt: null

                });
                showNotification("Class status reverted to 'Scheduled'.", "success");
                await updateAllDashboardStats(); // Update stats after action
            } catch (error) {
                console.error("Error reverting completion:", error);
                showNotification(`Error: ${error.message}`, "error");
            }
        }

        async function reinstateClass(id) {
            const slotDocRef = doc(db, "classSlots", id);
            if (!confirm("Are you sure you want to reinstate this cancelled class?")) {
                return;
            }
            try {
                await updateDoc(slotDocRef, {
                    status: 'scheduled',
                    cancellationReason: '',
                    statusChangedAt: null
                });
                showNotification("Class has been reinstated.", "success");
                await updateAllDashboardStats(); // Update stats after action
            } catch (error) {
                console.error("Error reinstating class:", error);
                showNotification(`Error: ${error.message}`, "error");
            }
        }

        async function cancelSlot(id) {
            const slotDocRef = doc(db, "classSlots", id);
            const docSnap = await getDoc(slotDocRef);

            if (!docSnap.exists()) { showNotification("Slot not found.", "error"); return; }
            if (!currentUser.isAdmin && docSnap.data().teacherId !== currentUser.uid) {
                showNotification("Permission denied to cancel this slot.", "error"); return;
            }

            const reason = prompt("Please enter the reason for cancelling this class slot:");
            if (reason === null) { showNotification("Cancellation aborted.", "warning"); return; }
            if (reason.trim() === "") { showNotification("Cancellation reason cannot be empty.", "error"); return; }

            try {
                await updateDoc(slotDocRef, {
                    status: 'cancelled',
                    cancellationReason: reason.trim(),
                    earnings: 0,
                    statusChangedAt: new Date().toISOString()
                });
                showNotification("Slot cancelled successfully.", "success");
                await updateAllDashboardStats(); // Update stats after action
            } catch (error) {
                console.error("Error cancelling slot:", error);
                showNotification(`Error cancelling slot: ${error.message}`, "error");
            }
        }

        async function deleteSlot(id) {
            const slotDocRef = doc(db, "classSlots", id);
            const docSnap = await getDoc(slotDocRef);

            if (!docSnap.exists()) {
                showNotification("Slot not found.", "error");
                return;
            }

            const slotData = docSnap.data();

            if (!currentUser.isAdmin && slotData.teacherId !== currentUser.uid) {
                showNotification("Permission denied to delete this slot.", "error");
                return;
            }

            deleteConfirmModal.dataset.slotId = id;
            deleteConfirmModal.dataset.isRecurring = slotData.recurringId ? 'true' : 'false';
            if (slotData.recurringId) {
                deleteConfirmModal.dataset.recurringId = slotData.recurringId;
                deleteConfirmModal.dataset.slotDate = slotData.date;
            }

            deleteOptionsContainer.classList.add('hidden');
            document.getElementById('delete-option-single').checked = true;

            if (slotData.recurringId) {
                deleteOptionsContainer.classList.remove('hidden');
                deleteModalMessage.textContent = "This is a recurring class. How would you like to delete it?";
            } else {
                deleteModalMessage.textContent = "Are you sure you want to permanently delete this class slot? This action cannot be undone.";
            }

            deleteConfirmModal.classList.add('active');
        }

        confirmDeleteButton.addEventListener('click', async () => {
            const slotId = deleteConfirmModal.dataset.slotId;
            if (!slotId) {
                console.error("Delete action triggered but no slotId found in modal dataset.");
                return;
            }

            confirmDeleteButton.disabled = true;
            const originalButtonHTML = confirmDeleteButton.innerHTML;
            confirmDeleteButton.innerHTML = `<span class="loader"></span>Deleting...`;

            try {
                const isRecurring = deleteConfirmModal.dataset.isRecurring === 'true';
                const deleteOption = isRecurring ? document.querySelector('input[name="delete-option"]:checked').value : 'single';

                if (isRecurring && deleteOption === 'future') {
                    const recurringId = deleteConfirmModal.dataset.recurringId;
                    const thisDate = deleteConfirmModal.dataset.slotDate;

                    const q = query(
                        collection(db, "classSlots"),
                        where("recurringId", "==", recurringId),
                        where("date", ">=", thisDate)
                    );
                    const seriesSnapshot = await getDocs(q);

                    const batch = writeBatch(db);
                    let deleteCount = 0;
                    seriesSnapshot.forEach(docToDelete => {
                        batch.delete(docToDelete.ref);
                        deleteCount++;
                    });

                    await batch.commit();
                    showNotification(`${deleteCount} recurring slot(s) deleted successfully.`, "success");

                } else {
                    await deleteDoc(doc(db, "classSlots", slotId));
                    showNotification("Slot deleted successfully.", "success");
                }
                await updateAllDashboardStats(); // Update stats after deletion
            } catch (error) {
                showNotification(`Error deleting slot(s): ${error.message}`, "error");
            } finally {
                confirmDeleteButton.disabled = false;
                confirmDeleteButton.innerHTML = originalButtonHTML;
                deleteConfirmModal.classList.remove('active');

                delete deleteConfirmModal.dataset.slotId;
                delete deleteConfirmModal.dataset.isRecurring;
                delete deleteConfirmModal.dataset.recurringId;
                delete deleteConfirmModal.dataset.slotDate;
            }
        });

        slotModal.addEventListener('click', (e) => {
            if (e.target === slotModal && !e.target.closest('.flatpickr-calendar')) {
                slotModal.classList.remove('active');
            }
        });

        closeDeleteModalButton.addEventListener('click', () => deleteConfirmModal.classList.remove('active'));
        cancelDeleteButton.addEventListener('click', () => deleteConfirmModal.classList.remove('active'));
        deleteConfirmModal.addEventListener('click', (e) => {
            if (e.target === deleteConfirmModal) {
                deleteConfirmModal.classList.remove('active');
            }
        });

        // =================================================================
        // START: NEW LOGIC FOR TEACHER OVERVIEW
        // =================================================================

        function toggleOverview(showOverview) {
            mainScheduleContent.classList.toggle('hidden', showOverview);
            teacherOverviewView.classList.toggle('hidden', !showOverview);

            if (showOverview) {
                const today = new Date();
                const dayOfWeek = today.getDay();
                overviewCurrentWeekStartDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - dayOfWeek);
                overviewCurrentWeekStartDate.setHours(0, 0, 0, 0);
                renderTeacherWeeklyOverview(overviewCurrentWeekStartDate);
            }
        }

        teacherOverviewButton.addEventListener('click', () => toggleOverview(true));
        mainTitle.addEventListener('click', () => toggleOverview(false));

        async function renderTeacherWeeklyOverview(startDate) {
            overviewGridContainer.innerHTML = `<div id="overview-loader">Fetching schedule data...</div>`;

            const start = new Date(startDate);
            const end = new Date(startDate);
            end.setDate(end.getDate() + 6);

            const startStr = getLocalDateString(start);
            const endStr = getLocalDateString(end);

            overviewWeekDisplay.textContent = `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            try {
                // Fetch all slots for the entire week
                const slotsCollectionRef = collection(db, "classSlots");
                const q = query(slotsCollectionRef,
                    where("date", ">=", startStr),
                    where("date", "<=", endStr),
                    orderBy("date"),
                    orderBy("startTime")
                );
                const querySnapshot = await getDocs(q);

                // Group slots by teacherId, then by date
                const slotsByTeacherAndDate = {};
                querySnapshot.forEach(docSnap => {
                    const slot = { id: docSnap.id, ...docSnap.data() };
                    if (!slotsByTeacherAndDate[slot.teacherId]) {
                        slotsByTeacherAndDate[slot.teacherId] = {};
                    }
                    if (!slotsByTeacherAndDate[slot.teacherId][slot.date]) {
                        slotsByTeacherAndDate[slot.teacherId][slot.date] = [];
                    }
                    slotsByTeacherAndDate[slot.teacherId][slot.date].push(slot);
                });

                // Build the grid
                overviewGridContainer.innerHTML = '';
                const grid = document.createElement('div');
                grid.className = 'overview-grid';

                // Header Row
                grid.innerHTML += `<div class="overview-header">Teacher</div>`;
                for (let i = 0; i < 7; i++) {
                    const day = new Date(start);
                    day.setDate(start.getDate() + i);
                    grid.innerHTML += `<div class="overview-header">${daysOfWeekDisplay[day.getDay()]}<br><span style="font-size: 0.8em; font-weight: 400;">${day.getDate()} ${day.toLocaleDateString('en-US', { month: 'short' })}</span></div>`;
                }

                // Teacher Rows
                allTeachersData.forEach(teacher => {
                    const teacherNameCell = document.createElement('div');
                    teacherNameCell.className = 'overview-teacher-name';
                    teacherNameCell.textContent = teacher.displayName || teacher.email;
                    grid.appendChild(teacherNameCell);

                    for (let i = 0; i < 7; i++) {
                        const day = new Date(start);
                        day.setDate(start.getDate() + i);
                        const dayString = getLocalDateString(day);
                        const todayString = getLocalDateString(new Date());

                        const dayCell = document.createElement('div');
                        dayCell.className = 'overview-day-cell';
                        if (dayString === todayString) {
                            dayCell.classList.add('is-today');
                        }

                        const slotsForDay = slotsByTeacherAndDate[teacher.id]?.[dayString] || [];

                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'day-header';
                        dayHeader.innerHTML = `<span>Classes: <span class="class-count">${slotsForDay.length}</span></span>`;
                        dayCell.appendChild(dayHeader);

                        slotsForDay.forEach(slot => {
                            const slotDiv = document.createElement('div');
                            slotDiv.className = 'overview-slot';
                            slotDiv.classList.add(`is-${slot.status}`);
                            slotDiv.innerHTML = `<span class="overview-slot-time">${slot.startTime}</span> ${slot.topic}`;

                            // Make slot clickable to open the edit modal
                            slotDiv.addEventListener('click', async () => {
                                const fullSlotDoc = await getDoc(doc(db, "classSlots", slot.id));
                                if (fullSlotDoc.exists()) {
                                    await selectDay(new Date(slot.date.replace(/-/g, '/'))); // Set context
                                    openSlotModal(slot.id, { id: slot.id, ...fullSlotDoc.data() });
                                }
                            });
                            dayCell.appendChild(slotDiv);
                        });
                        grid.appendChild(dayCell);
                    }
                });

                overviewGridContainer.appendChild(grid);

            } catch (error) {
                console.error("Error rendering teacher weekly overview:", error);
                showNotification("Could not load the teacher overview.", "error");
                overviewGridContainer.innerHTML = `<div id="overview-loader" style="color: var(--accent-red);">Error loading schedule. Please try again.</div>`;
            }
        }

        overviewPrevWeekButton.addEventListener('click', () => {
            if (!overviewCurrentWeekStartDate) return;
            overviewCurrentWeekStartDate.setDate(overviewCurrentWeekStartDate.getDate() - 7);
            renderTeacherWeeklyOverview(overviewCurrentWeekStartDate);
        });

        overviewNextWeekButton.addEventListener('click', () => {
            if (!overviewCurrentWeekStartDate) return;
            overviewCurrentWeekStartDate.setDate(overviewCurrentWeekStartDate.getDate() + 7);
            renderTeacherWeeklyOverview(overviewCurrentWeekStartDate);
        });

        // =================================================================
        // END: NEW LOGIC FOR TEACHER OVERVIEW
        // =================================================================

        // =================================================================
        // START: ADMIN TEACHER MANAGEMENT
        // =================================================================

        const teacherManagementModal = document.getElementById('teacher-management-modal');
        const closeTeacherModalButton = document.getElementById('close-teacher-modal-button');
        const teachersList = document.getElementById('teachers-list');
        const createTeacherButton = document.getElementById('create-teacher-button');
        const newTeacherName = document.getElementById('new-teacher-name');
        const newTeacherEmail = document.getElementById('new-teacher-email');
        const newTeacherPassword = document.getElementById('new-teacher-password');

        // Open teacher management modal
        window.openTeacherManagementModal = async function () {
            if (!teacherManagementModal) return;
            teacherManagementModal.classList.add('active');
            await loadTeachersList();
        }

        // Close modal
        if (closeTeacherModalButton) {
            closeTeacherModalButton.addEventListener('click', () => {
                teacherManagementModal.classList.remove('active');
                // Clear form
                newTeacherName.value = '';
                newTeacherEmail.value = '';
                newTeacherPassword.value = '';
            });
        }

        // Close on outside click
        if (teacherManagementModal) {
            teacherManagementModal.addEventListener('click', (e) => {
                if (e.target === teacherManagementModal) {
                    teacherManagementModal.classList.remove('active');
                }
            });
        }

        // Get ID token for API calls
        async function getIdToken() {
            const user = auth.currentUser;
            if (!user) throw new Error('Not authenticated');
            return await user.getIdToken();
        }

        // Load teachers list
        async function loadTeachersList() {
            if (!teachersList) return;

            teachersList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading teachers...</div>';

            try {
                const token = await getIdToken();
                const response = await fetch('/api/list-teachers', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to load teachers');
                }

                teachersList.innerHTML = '';

                if (data.teachers.length === 0) {
                    teachersList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No teachers found. Add your first teacher above!</div>';
                    return;
                }

                data.teachers.forEach(teacher => {
                    const teacherCard = document.createElement('div');
                    teacherCard.className = 'teacher-card';
                    teacherCard.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1rem;
                        margin-bottom: 0.75rem;
                        background-color: var(--bg-primary);
                        border: 1px solid var(--border-color);
                        border-radius: var(--border-radius);
                    `;

                    const createdDate = teacher.createdAt ? new Date(teacher.createdAt).toLocaleDateString() : 'Unknown';

                    teacherCard.innerHTML = `
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${teacher.displayName || 'Unknown'}</div>
                            <div style="font-size: 0.85em; color: var(--text-muted);">${teacher.email}</div>
                            <div style="font-size: 0.75em; color: var(--text-muted);">Added: ${createdDate}</div>
                        </div>
                        <button class="btn btn-danger btn-small delete-teacher-btn" data-uid="${teacher.uid}" data-name="${teacher.displayName}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                            Delete
                        </button>
                    `;

                    teachersList.appendChild(teacherCard);
                });

                // Add delete button listeners
                document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const uid = e.target.dataset.uid;
                        const name = e.target.dataset.name;
                        await deleteTeacher(uid, name);
                    });
                });

            } catch (error) {
                console.error('Error loading teachers:', error);
                teachersList.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--accent-red);">Error: ${error.message}</div>`;
            }
        }

        // Create new teacher
        if (createTeacherButton) {
            createTeacherButton.addEventListener('click', async () => {
                const name = newTeacherName.value.trim();
                const email = newTeacherEmail.value.trim();
                const password = newTeacherPassword.value;

                if (!name || !email || !password) {
                    showNotification('Please fill in all fields.', 'warning');
                    return;
                }

                if (password.length < 6) {
                    showNotification('Password must be at least 6 characters.', 'warning');
                    return;
                }

                createTeacherButton.disabled = true;
                const originalText = createTeacherButton.textContent;
                createTeacherButton.innerHTML = '<span class="loader"></span> Creating...';

                try {
                    const token = await getIdToken();
                    const response = await fetch('/api/create-teacher', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            displayName: name,
                            email: email,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to create teacher');
                    }

                    showNotification(`Teacher "${name}" created successfully!`, 'success');

                    // Clear form
                    newTeacherName.value = '';
                    newTeacherEmail.value = '';
                    newTeacherPassword.value = '';

                    // Reload list
                    await loadTeachersList();

                } catch (error) {
                    console.error('Error creating teacher:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    createTeacherButton.disabled = false;
                    createTeacherButton.textContent = originalText;
                }
            });
        }

        // Delete teacher
        async function deleteTeacher(uid, name) {
            const confirmed = confirm(`Are you sure you want to delete teacher "${name}"?\n\nThis will permanently remove their account and they will no longer be able to login.`);

            if (!confirmed) return;

            try {
                const token = await getIdToken();
                const response = await fetch('/api/delete-teacher', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ uid })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to delete teacher');
                }

                showNotification(`Teacher "${name}" deleted successfully.`, 'success');

                // Reload list
                await loadTeachersList();

            } catch (error) {
                console.error('Error deleting teacher:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // =================================================================
        // END: ADMIN TEACHER MANAGEMENT
        // =================================================================

        // =================================================================
        // START: ADMIN STUDENT MANAGEMENT
        // =================================================================

        const studentManagementModal = document.getElementById('student-management-modal');
        const closeStudentModalButton = document.getElementById('close-student-modal-button');
        const studentsList = document.getElementById('students-list');
        const createStudentButton = document.getElementById('create-student-button');
        const newStudentName = document.getElementById('new-student-name');
        const newStudentEmail = document.getElementById('new-student-email');
        const newStudentPassword = document.getElementById('new-student-password');
        const newStudentBatches = document.getElementById('new-student-batches');

        window.openStudentManagementModal = async function () {
            if (!studentManagementModal) return;
            studentManagementModal.classList.add('active');
            await loadStudentsList();
        }

        if (closeStudentModalButton) {
            closeStudentModalButton.addEventListener('click', () => {
                studentManagementModal.classList.remove('active');
                newStudentName.value = '';
                newStudentEmail.value = '';
                newStudentPassword.value = '';
                newStudentBatches.value = '';
            });
        }

        if (studentManagementModal) {
            studentManagementModal.addEventListener('click', (e) => {
                if (e.target === studentManagementModal) {
                    studentManagementModal.classList.remove('active');
                }
            });
        }

        async function loadStudentsList() {
            if (!studentsList) return;
            studentsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading students...</div>';

            try {
                const token = await getIdToken();
                const response = await fetch('/api/list-students', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Failed to load students');

                studentsList.innerHTML = '';

                if (data.students.length === 0) {
                    studentsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No students found. Add your first student above!</div>';
                    return;
                }

                data.students.forEach(student => {
                    const card = document.createElement('div');
                    card.style.cssText = `display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin-bottom: 0.75rem; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--border-radius);`;

                    const createdDate = student.createdAt ? new Date(student.createdAt).toLocaleDateString() : 'Unknown';
                    const batchesText = (student.batches && student.batches.length > 0) ? student.batches.join(', ') : 'No batches';

                    card.innerHTML = `
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${student.displayName || 'Unknown'}</div>
                            <div style="font-size: 0.85em; color: var(--text-muted);">${student.email}</div>
                            <div style="font-size: 0.78em; color: var(--accent-secondary);">Batches: ${batchesText}</div>
                            <div style="font-size: 0.75em; color: var(--text-muted);">Added: ${createdDate}</div>
                        </div>
                        <button class="btn btn-danger btn-small delete-student-btn" data-uid="${student.uid}" data-name="${student.displayName}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                            Delete
                        </button>
                    `;
                    studentsList.appendChild(card);
                });

                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const uid = e.target.dataset.uid;
                        const name = e.target.dataset.name;
                        await deleteStudent(uid, name);
                    });
                });

            } catch (error) {
                console.error('Error loading students:', error);
                studentsList.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--accent-red);">Error: ${error.message}</div>`;
            }
        }

        if (createStudentButton) {
            createStudentButton.addEventListener('click', async () => {
                const name = newStudentName.value.trim();
                const email = newStudentEmail.value.trim();
                const password = newStudentPassword.value;
                const batches = newStudentBatches.value.split(',').map(b => b.trim()).filter(b => b.length > 0);

                if (!name || !email || !password) {
                    showNotification('Please fill in name, email, and password.', 'warning');
                    return;
                }
                if (password.length < 6) {
                    showNotification('Password must be at least 6 characters.', 'warning');
                    return;
                }

                createStudentButton.disabled = true;
                const originalText = createStudentButton.textContent;
                createStudentButton.innerHTML = '<span class="loader"></span> Creating...';

                try {
                    const token = await getIdToken();
                    const response = await fetch('/api/create-student', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ displayName: name, email, password, batches })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to create student');

                    showNotification(`Student "${name}" created successfully!`, 'success');
                    newStudentName.value = '';
                    newStudentEmail.value = '';
                    newStudentPassword.value = '';
                    newStudentBatches.value = '';
                    await loadStudentsList();

                } catch (error) {
                    console.error('Error creating student:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    createStudentButton.disabled = false;
                    createStudentButton.textContent = originalText;
                }
            });
        }

        async function deleteStudent(uid, name) {
            const confirmed = confirm(`Are you sure you want to delete student "${name}"?\n\nThis will permanently remove their account.`);
            if (!confirmed) return;

            try {
                const token = await getIdToken();
                const response = await fetch('/api/delete-student', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ uid })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Failed to delete student');

                showNotification(`Student "${name}" deleted successfully.`, 'success');
                await loadStudentsList();

            } catch (error) {
                console.error('Error deleting student:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // =================================================================
        // END: ADMIN STUDENT MANAGEMENT
        // =================================================================

        // =================================================================
        // START: TEACHER ASSIGNMENT POSTING
        // =================================================================

        const assignmentModal = document.getElementById('assignment-modal');
        const closeAssignmentModalButton = document.getElementById('close-assignment-modal-button');
        const saveAssignmentButton = document.getElementById('save-assignment-button');
        const assignmentTitleInput = document.getElementById('assignment-title');
        const assignmentDescInput = document.getElementById('assignment-description');
        const assignmentDueDateInput = document.getElementById('assignment-due-date');
        const assignmentBatchInput = document.getElementById('assignment-batch');

        let assignmentDueDatePicker = null;

        // Add "Post Assignment" button to the add-slot button area
        if (addSlotButton && addSlotButton.parentElement) {
            const postAssignmentBtn = document.createElement('button');
            postAssignmentBtn.id = 'post-assignment-button';
            postAssignmentBtn.className = 'btn btn-warning';
            postAssignmentBtn.textContent = ' Post Assignment';
            postAssignmentBtn.style.marginLeft = '10px';
            postAssignmentBtn.addEventListener('click', () => {
                if (!assignmentDueDatePicker) {
                    assignmentDueDatePicker = flatpickr(assignmentDueDateInput, {
                        dateFormat: "Y-m-d",
                        theme: "dark",
                        minDate: "today"
                    });
                }
                assignmentModal.classList.add('active');
            });
            addSlotButton.parentElement.appendChild(postAssignmentBtn);
        }

        if (closeAssignmentModalButton) {
            closeAssignmentModalButton.addEventListener('click', () => {
                assignmentModal.classList.remove('active');
            });
        }

        if (assignmentModal) {
            assignmentModal.addEventListener('click', (e) => {
                if (e.target === assignmentModal) assignmentModal.classList.remove('active');
            });
        }

        if (saveAssignmentButton) {
            saveAssignmentButton.addEventListener('click', async () => {
                const title = assignmentTitleInput.value.trim();
                const description = assignmentDescInput.value.trim();
                const dueDate = assignmentDueDateInput.value.trim();
                const batch = assignmentBatchInput.value.trim();

                if (!title || !dueDate) {
                    showNotification('Title and due date are required.', 'warning');
                    return;
                }

                saveAssignmentButton.disabled = true;
                saveAssignmentButton.innerHTML = '<span class="loader"></span> Posting...';

                try {
                    const batches = batch.split(',').map(b => b.trim()).filter(b => b.length > 0);
                    await addDoc(collection(db, "assignments"), {
                        title,
                        description,
                        dueDate,
                        batches,
                        teacherId: currentUser.uid,
                        teacherName: currentUser.originalDisplayName || currentTeacherName,
                        createdAt: serverTimestamp(),
                        status: 'active'
                    });

                    showNotification('Assignment posted successfully!', 'success');
                    assignmentTitleInput.value = '';
                    assignmentDescInput.value = '';
                    assignmentDueDateInput.value = '';
                    assignmentBatchInput.value = '';
                    assignmentModal.classList.remove('active');

                } catch (error) {
                    console.error('Error posting assignment:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    saveAssignmentButton.disabled = false;
                    saveAssignmentButton.textContent = 'Post Assignment';
                }
            });
        }

        // =================================================================
        // END: TEACHER ASSIGNMENT POSTING
        // =================================================================

        // =================================================================
        // START: STUDENT DASHBOARD LOGIC
        // =================================================================

        async function initStudentDashboard() {
            if (!currentUser || !currentUser.isStudent) return;

            const batches = currentUser.studentBatches || [];
            const todayStr = getLocalDateString(new Date());
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // --- Setup calendar ---
            const calContainer = document.getElementById('student-calendar-container');
            if (window._studentCalendar) window._studentCalendar.destroy();
            window._studentCalendar = flatpickr(calContainer, {
                inline: true,
                theme: "dark",
                onChange: function (selectedDates) {
                    if (selectedDates.length > 0) {
                        renderStudentDayClasses(selectedDates[0]);
                    }
                }
            });

            // --- Real-time listener for classes ---
            if (window._unsubStudentClasses) window._unsubStudentClasses();

            const classesQuery = query(collection(db, "classSlots"),
                where("status", "in", ["scheduled", "completed"]),
                orderBy("date"),
                orderBy("startTime")
            );

            window._allStudentClasses = [];
            window._unsubStudentClasses = onSnapshot(classesQuery, (snapshot) => {
                window._allStudentClasses = [];
                snapshot.forEach(docSnap => {
                    window._allStudentClasses.push({ id: docSnap.id, ...docSnap.data() });
                });
                updateStudentStats();
                renderStudentUpcomingClasses();
                // Refresh day view if a date was selected
                const selectedDate = window._studentCalendar?.selectedDates?.[0];
                if (selectedDate) renderStudentDayClasses(selectedDate);
            });

            // --- Real-time listener for assignments ---
            if (window._unsubStudentAssignments) window._unsubStudentAssignments();

            const assignmentsQuery = query(collection(db, "assignments"),
                where("status", "==", "active"),
                orderBy("dueDate")
            );

            window._allStudentAssignments = [];
            window._unsubStudentAssignments = onSnapshot(assignmentsQuery, (snapshot) => {
                window._allStudentAssignments = [];
                snapshot.forEach(docSnap => {
                    window._allStudentAssignments.push({ id: docSnap.id, ...docSnap.data() });
                });
                renderStudentAssignments();
                updateStudentStats();
            });

            // --- Load attendance ---
            await renderStudentAttendance();
        }

        function updateStudentStats() {
            const today = new Date();
            const todayStr = getLocalDateString(today);
            const dayOfWeek = today.getDay();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - dayOfWeek);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const allClasses = window._allStudentClasses || [];

            // Today's classes
            const todayClasses = allClasses.filter(c => c.date === todayStr);
            document.getElementById('student-today-classes').textContent = todayClasses.length;

            // This week's classes
            const weekStartStr = getLocalDateString(weekStart);
            const weekEndStr = getLocalDateString(weekEnd);
            const weekClasses = allClasses.filter(c => c.date >= weekStartStr && c.date <= weekEndStr);
            document.getElementById('student-week-classes').textContent = weekClasses.length;

            // Pending assignments
            const allAssignments = window._allStudentAssignments || [];
            const pendingAssignments = allAssignments.filter(a => a.dueDate >= todayStr);
            document.getElementById('student-pending-assignments').textContent = pendingAssignments.length;
        }

        function renderStudentUpcomingClasses() {
            const container = document.getElementById('student-upcoming-classes');
            const todayStr = getLocalDateString(new Date());
            const allClasses = window._allStudentClasses || [];

            const upcoming = allClasses
                .filter(c => c.date >= todayStr && c.status === 'scheduled')
                .slice(0, 5);

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No upcoming classes scheduled</div></div>';
                return;
            }

            container.innerHTML = upcoming.map(cls => {
                const dateObj = new Date(cls.date.replace(/-/g, '/'));
                const dateDisplay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' });
                const displayStart = calculateDisplayStartTime(cls.startTime);
                const displayEnd = calculateDisplayEndTime(cls.startTime, cls.endTime);
                return `
                    <div class="class-event-card">
                        <div class="event-time">${dateDisplay}  ${displayStart}  ${displayEnd}</div>
                        <div class="event-topic">${cls.topic || 'Class Session'}</div>
                        <div class="event-teacher"> ${cls.teacherName || 'Teacher'}</div>
                    </div>
                `;
            }).join('');
        }

        function renderStudentDayClasses(date) {
            const dateStr = getLocalDateString(date);
            const dateDisplay = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('student-selected-date-text').textContent = dateDisplay;

            const container = document.getElementById('student-day-classes-list');
            const allClasses = window._allStudentClasses || [];

            const dayClasses = allClasses.filter(c => c.date === dateStr);

            // Also show assignments due on this day
            const allAssignments = window._allStudentAssignments || [];
            const dayAssignments = allAssignments.filter(a => a.dueDate === dateStr);

            if (dayClasses.length === 0 && dayAssignments.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No classes or assignments on this day</div></div>';
                return;
            }

            let html = '';

            dayClasses.forEach(cls => {
                const displayStart = calculateDisplayStartTime(cls.startTime);
                const displayEnd = calculateDisplayEndTime(cls.startTime, cls.endTime);
                const statusBadge = cls.status === 'completed' ?
                    '<span style="color: var(--accent-green); font-size: 0.75rem;"> Completed</span>' :
                    '<span style="color: var(--accent-secondary); font-size: 0.75rem;"> Scheduled</span>';

                html += `
                    <div class="class-event-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="event-time">${displayStart}  ${displayEnd}</div>
                            ${statusBadge}
                        </div>
                        <div class="event-topic">${cls.topic || 'Class Session'}</div>
                        <div class="event-teacher"> ${cls.teacherName || 'Teacher'}</div>
                    </div>
                `;
            });

            dayAssignments.forEach(asn => {
                html += `
                    <div class="assignment-card">
                        <div class="assignment-title"> ${asn.title}</div>
                        <div class="assignment-due">Due: ${dateDisplay}</div>
                        ${asn.description ? `<div class="assignment-desc">${asn.description}</div>` : ''}
                        <div class="assignment-teacher">By: ${asn.teacherName || 'Teacher'}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderStudentAssignments() {
            const container = document.getElementById('student-assignments-list');
            const todayStr = getLocalDateString(new Date());
            const allAssignments = window._allStudentAssignments || [];

            const active = allAssignments.filter(a => a.dueDate >= todayStr);

            if (active.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No pending assignments  you\'re all caught up!</div></div>';
                return;
            }

            container.innerHTML = active.map(asn => {
                const dueDate = new Date(asn.dueDate.replace(/-/g, '/'));
                const daysUntilDue = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                const urgencyColor = daysUntilDue <= 1 ? 'var(--accent-red)' : daysUntilDue <= 3 ? 'var(--accent-orange)' : 'var(--accent-green)';
                const dueText = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' });

                return `
                    <div class="assignment-card">
                        <div class="assignment-title">${asn.title}</div>
                        <div class="assignment-due" style="color: ${urgencyColor};">Due: ${dueText} ${daysUntilDue <= 1 ? '' : ''}</div>
                        ${asn.description ? `<div class="assignment-desc">${asn.description}</div>` : ''}
                        <div class="assignment-teacher">By: ${asn.teacherName || 'Teacher'}</div>
                    </div>
                `;
            }).join('');
        }

        async function renderStudentAttendance() {
            if (!currentUser) return;

            try {
                const attendanceQuery = query(
                    collection(db, "attendance"),
                    where("studentId", "==", currentUser.uid),
                    orderBy("date", "desc"),
                    limit(30)
                );

                const snapshot = await getDocs(attendanceQuery);
                const records = [];
                snapshot.forEach(docSnap => records.push(docSnap.data()));

                const totalRecords = records.length;
                const presentCount = records.filter(r => r.status === 'present').length;
                const attendancePercentage = totalRecords > 0 ? Math.round((presentCount / totalRecords) * 100) : 0;

                // Update stats card
                document.getElementById('student-attendance-rate').textContent = totalRecords > 0 ? `${attendancePercentage}%` : '';

                // Update detailed attendance section
                const percentEl = document.getElementById('student-attendance-percent');
                const barEl = document.getElementById('student-attendance-bar');
                const logEl = document.getElementById('student-attendance-log');

                if (totalRecords > 0) {
                    percentEl.textContent = `${attendancePercentage}%`;
                    percentEl.style.color = attendancePercentage >= 75 ? 'var(--accent-green)' : 'var(--accent-red)';
                    barEl.style.width = `${attendancePercentage}%`;
                    barEl.className = `attendance-bar${attendancePercentage < 75 ? ' low' : ''}`;

                    logEl.innerHTML = records.slice(0, 15).map(r => {
                        const dateObj = new Date(r.date.replace(/-/g, '/'));
                        const dateText = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const isPresent = r.status === 'present';
                        return `
                            <div class="attendance-log-item">
                                <span class="att-date">${dateText}${r.topic ? `  ${r.topic}` : ''}</span>
                                <span class="att-status ${isPresent ? 'present' : 'absent'}">${isPresent ? 'Present' : 'Absent'}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    percentEl.textContent = '%';
                    barEl.style.width = '0%';
                    logEl.innerHTML = '<div class="empty-state" style="padding: 1rem;">No attendance records yet</div>';
                }

            } catch (error) {
                console.error('Error loading attendance:', error);
            }
        }

        // =================================================================
        // END: STUDENT DASHBOARD LOGIC
        // =================================================================

        updateDateDisplay();
    </script>
</body>

</html>